# Azure Key Vault - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Implement Azure Security (15-20%)

This lab extends the basic Key Vault exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [Key Vault lab](README.md) first to understand fundamental Key Vault operations.

## AZ-204 Exam Skills Covered

- Secure app configuration data using Azure Key Vault
- Develop code that uses keys, secrets, and certificates stored in Key Vault
- Implement Managed Identities for Azure resources
- Set and retrieve secrets using SDK
- Key Vault access policies vs Azure RBAC
- Secret versioning and rotation

## Exercise 1: Working with Secrets

### Create and Manage Secrets

```bash
az group create -n labs-keyvault-az204 --tags courselabs=azure -l eastus

# Create Key Vault (name must be globally unique)
az keyvault create \
  -g labs-keyvault-az204 \
  -n <keyvault-name> \
  -l eastus \
  --enable-rbac-authorization false
```

Add secrets with different content types:

```bash
# Database connection string
az keyvault secret set \
  --vault-name <keyvault-name> \
  --name "DatabaseConnectionString" \
  --value "Server=tcp:myserver.database.windows.net;Database=mydb;User ID=admin;Password=P@ssw0rd;" \
  --content-type "connection-string"

# API key
az keyvault secret set \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --value "sk-1234567890abcdef" \
  --content-type "api-key"

# JSON configuration
az keyvault secret set \
  --vault-name <keyvault-name> \
  --name "AppConfig" \
  --value '{"feature1":true,"maxRetries":3,"timeout":30}' \
  --content-type "application/json"
```

ðŸ“‹ Retrieve the API key secret and its metadata.

<details>
  <summary>Not sure how?</summary>

```bash
# Get secret value
az keyvault secret show \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --query value -o tsv

# Get secret metadata
az keyvault secret show \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --query '{name:name, contentType:contentType, created:attributes.created, updated:attributes.updated, enabled:attributes.enabled}'
```

</details><br/>

> **AZ-204 Exam Tip:** Secrets have metadata including content type, enabled/disabled status, activation date, and expiration date. Use content-type to document the secret's purpose.

### Secret Versioning and Rotation

Key Vault automatically versions secrets when you update them:

```bash
# Update the API key (creates new version)
az keyvault secret set \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --value "sk-new-key-9876543210"

# List all versions
az keyvault secret list-versions \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  -o table
```

Get a specific version:

```bash
# Get the latest version
az keyvault secret show \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --query value -o tsv

# Get specific version (use version ID from list-versions)
az keyvault secret show \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --version <version-id> \
  --query value -o tsv
```

ðŸ“‹ Set an expiration date for a secret (30 days from now).

<details>
  <summary>Not sure how?</summary>

```bash
# Calculate expiration date (30 days from now)
EXPIRY_DATE=$(date -u -d "+30 days" '+%Y-%m-%dT%H:%M:%SZ')

az keyvault secret set-attributes \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey" \
  --expires "$EXPIRY_DATE"
```

</details><br/>

> **AZ-204 Exam Tip:** Always reference secrets by name without version in application code. This allows transparent secret rotation without code changes.

## Exercise 2: Working with Keys

**AZ-204 Topic:** Keys are used for cryptographic operations.

### Create and Use Cryptographic Keys

```bash
# Create RSA key
az keyvault key create \
  --vault-name <keyvault-name> \
  --name "app-encryption-key" \
  --kty RSA \
  --size 2048 \
  --ops encrypt decrypt

# Create EC (Elliptic Curve) key for signing
az keyvault key create \
  --vault-name <keyvault-name> \
  --name "document-signing-key" \
  --kty EC \
  --curve P-256 \
  --ops sign verify
```

List keys:

```bash
az keyvault key list \
  --vault-name <keyvault-name> \
  -o table
```

Show key details:

```bash
az keyvault key show \
  --vault-name <keyvault-name> \
  --name "app-encryption-key"
```

> **AZ-204 Exam Tip:** Key types:
> - **RSA**: Encryption/decryption, signing (2048, 3072, 4096 bits)
> - **EC**: Signing/verification (P-256, P-384, P-521 curves)
> - **oct**: Symmetric keys for encryption

### Key Operations

Supported operations:
- **encrypt/decrypt**: Data encryption
- **sign/verify**: Digital signatures
- **wrapKey/unwrapKey**: Key encryption (envelope encryption)
- **import/export**: Key management

## Exercise 3: Working with Certificates

**AZ-204 Topic:** Certificates combine keys with identity metadata.

### Create Self-Signed Certificate

Create certificate policy file:

```bash
cat > cert-policy.json << 'EOF'
{
  "issuerParameters": {
    "name": "Self"
  },
  "keyProperties": {
    "exportable": true,
    "keySize": 2048,
    "keyType": "RSA",
    "reuseKey": false
  },
  "secretProperties": {
    "contentType": "application/x-pkcs12"
  },
  "x509CertificateProperties": {
    "subject": "CN=myapp.azurewebsites.net",
    "validityInMonths": 12,
    "subjectAlternativeNames": {
      "dnsNames": [
        "myapp.azurewebsites.net",
        "www.myapp.azurewebsites.net"
      ]
    }
  }
}
EOF
```

Create certificate:

```bash
az keyvault certificate create \
  --vault-name <keyvault-name> \
  --name "app-certificate" \
  --policy @cert-policy.json
```

List certificates:

```bash
az keyvault certificate list \
  --vault-name <keyvault-name> \
  -o table
```

ðŸ“‹ Download the certificate in PEM format.

<details>
  <summary>Not sure how?</summary>

```bash
az keyvault certificate download \
  --vault-name <keyvault-name> \
  --name "app-certificate" \
  --file app-cert.pem \
  --encoding PEM
```

</details><br/>

## Exercise 4: Managed Identities

**AZ-204 Critical Topic:** Managed Identities eliminate the need for credentials in code.

### System-Assigned Managed Identity

Create an App Service with system-assigned managed identity:

```bash
# Create App Service Plan
az appservice plan create \
  -g labs-keyvault-az204 \
  -n keyvault-plan \
  --sku B1

# Create Web App with managed identity
az webapp create \
  -g labs-keyvault-az204 \
  -p keyvault-plan \
  -n <webapp-name> \
  --runtime "DOTNET:6.0" \
  --assign-identity [system]
```

Get the managed identity principal ID:

```bash
PRINCIPAL_ID=$(az webapp identity show \
  -g labs-keyvault-az204 \
  -n <webapp-name> \
  --query principalId -o tsv)

echo "Managed Identity Principal ID: $PRINCIPAL_ID"
```

Grant the managed identity access to Key Vault:

```bash
az keyvault set-policy \
  --name <keyvault-name> \
  --object-id $PRINCIPAL_ID \
  --secret-permissions get list
```

> **AZ-204 Exam Tip:** System-assigned vs User-assigned managed identities:
> - **System-assigned**: Tied to resource lifecycle, deleted with resource
> - **User-assigned**: Independent lifecycle, can be shared across resources

### User-Assigned Managed Identity

```bash
# Create user-assigned managed identity
az identity create \
  -g labs-keyvault-az204 \
  -n myUserIdentity

# Get identity details
USER_IDENTITY_ID=$(az identity show \
  -g labs-keyvault-az204 \
  -n myUserIdentity \
  --query id -o tsv)

USER_PRINCIPAL_ID=$(az identity show \
  -g labs-keyvault-az204 \
  -n myUserIdentity \
  --query principalId -o tsv)

# Assign to web app
az webapp identity assign \
  -g labs-keyvault-az204 \
  -n <webapp-name> \
  --identities $USER_IDENTITY_ID

# Grant access to Key Vault
az keyvault set-policy \
  --name <keyvault-name> \
  --object-id $USER_PRINCIPAL_ID \
  --secret-permissions get list
```

## Exercise 5: Access Policies vs RBAC

**AZ-204 Topic:** Two permission models for Key Vault.

### Access Policies (Classic)

```bash
# Grant user full permissions to secrets
az keyvault set-policy \
  --name <keyvault-name> \
  --upn user@contoso.com \
  --secret-permissions get list set delete backup restore recover purge

# Grant application limited permissions
az keyvault set-policy \
  --name <keyvault-name> \
  --object-id <app-object-id> \
  --secret-permissions get list
```

### Azure RBAC (Recommended for new vaults)

```bash
# Create Key Vault with RBAC enabled
az keyvault create \
  -g labs-keyvault-az204 \
  -n <keyvault-rbac-name> \
  --enable-rbac-authorization true

# Assign RBAC roles
az role assignment create \
  --role "Key Vault Secrets Officer" \
  --assignee user@contoso.com \
  --scope "/subscriptions/<sub-id>/resourceGroups/labs-keyvault-az204/providers/Microsoft.KeyVault/vaults/<keyvault-rbac-name>"
```

> **AZ-204 Exam Tip:** RBAC roles for Key Vault:
> - **Key Vault Administrator**: Full access
> - **Key Vault Secrets Officer**: Manage secrets
> - **Key Vault Secrets User**: Read secrets
> - **Key Vault Crypto Officer**: Manage keys
> - **Key Vault Crypto User**: Use keys for crypto operations
> - **Key Vault Certificates Officer**: Manage certificates

## Exercise 6: Using Key Vault in Application Code

**AZ-204 Critical:** SDK integration with managed identities.

### .NET SDK Example

```csharp
using Azure.Identity;
using Azure.Security.KeyVault.Secrets;
using Microsoft.Extensions.Configuration;

// Using Managed Identity (DefaultAzureCredential)
var client = new SecretClient(
    new Uri("https://<keyvault-name>.vault.azure.net/"),
    new DefaultAzureCredential());

// Get secret
KeyVaultSecret secret = await client.GetSecretAsync("DatabaseConnectionString");
Console.WriteLine($"Secret value: {secret.Value}");

// Set secret
await client.SetSecretAsync("NewSecret", "SecretValue");

// Delete secret
await client.StartDeleteSecretAsync("OldSecret");
```

### Integration with App Configuration

```bash
# Reference Key Vault secret from App Settings
az webapp config appsettings set \
  -g labs-keyvault-az204 \
  -n <webapp-name> \
  --settings \
    "DatabaseConnection=@Microsoft.KeyVault(SecretUri=https://<keyvault-name>.vault.azure.net/secrets/DatabaseConnectionString/)"
```

> **AZ-204 Exam Tip:** The `@Microsoft.KeyVault(SecretUri=...)` syntax enables automatic Key Vault reference resolution in App Service. The app's managed identity must have Get permission on the secret.

### Python SDK Example

```python
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

credential = DefaultAzureCredential()
client = SecretClient(vault_url="https://<keyvault-name>.vault.azure.net/", credential=credential)

# Get secret
secret = client.get_secret("DatabaseConnectionString")
print(f"Secret value: {secret.value}")

# Set secret
client.set_secret("NewSecret", "SecretValue")
```

## Exercise 7: Key Vault Backup and Recovery

```bash
# Backup a secret
az keyvault secret backup \
  --vault-name <keyvault-name> \
  --name "DatabaseConnectionString" \
  --file secret-backup.blob

# Restore from backup
az keyvault secret restore \
  --vault-name <keyvault-name> \
  --file secret-backup.blob
```

### Soft Delete and Purge Protection

```bash
# Enable soft delete (enabled by default on new vaults)
az keyvault update \
  -g labs-keyvault-az204 \
  -n <keyvault-name> \
  --enable-soft-delete true \
  --retention-days 90

# Enable purge protection (prevents permanent deletion)
az keyvault update \
  -g labs-keyvault-az204 \
  -n <keyvault-name> \
  --enable-purge-protection true
```

Delete and recover a secret:

```bash
# Delete secret (soft delete)
az keyvault secret delete \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey"

# List deleted secrets
az keyvault secret list-deleted \
  --vault-name <keyvault-name>

# Recover deleted secret
az keyvault secret recover \
  --vault-name <keyvault-name> \
  --name "ExternalApiKey"

# Permanently delete (purge) - only if purge protection is disabled
# az keyvault secret purge --vault-name <keyvault-name> --name "ExternalApiKey"
```

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **Secret vs Key vs Certificate:**
   - **Secrets**: Passwords, connection strings, API keys
   - **Keys**: Cryptographic keys for encryption/signing
   - **Certificates**: Keys + identity metadata (X.509)

2. **Managed Identity Types:**
   - **System-assigned**: Lifecycle tied to resource
   - **User-assigned**: Independent, shareable across resources

3. **Authentication Methods:**
   - **Managed Identity**: Recommended for Azure resources
   - **Service Principal**: For applications outside Azure
   - **Certificate**: For advanced scenarios
   - **User credentials**: For development/testing only

4. **Permission Models:**
   - **Access Policies**: Resource-level, fine-grained permissions
   - **Azure RBAC**: Consistent with other Azure resources, recommended

5. **DefaultAzureCredential Chain:**
   1. Environment variables
   2. Managed Identity
   3. Visual Studio
   4. Azure CLI
   5. Azure PowerShell
   6. Interactive browser

### Common Exam Scenarios

1. **Scenario:** Web app needs to access database connection string securely
   - **Solution:** Store in Key Vault, use managed identity, reference in app settings with `@Microsoft.KeyVault()` syntax

2. **Scenario:** Rotate API key without application restart
   - **Solution:** Use Key Vault secret versioning, app references by name (no version)

3. **Scenario:** Multiple apps need same credential
   - **Solution:** User-assigned managed identity shared across apps

4. **Scenario:** Prevent accidental secret deletion
   - **Solution:** Enable soft delete and purge protection

5. **Scenario:** Local development needs Key Vault access
   - **Solution:** Use `DefaultAzureCredential` which falls back to Azure CLI credentials

## Best Practices

1. **Never hardcode secrets** in code or configuration files
2. **Always use Managed Identities** when running in Azure
3. **Enable soft delete and purge protection** for production vaults
4. **Use RBAC** for new Key Vaults (simpler management)
5. **Reference secrets by name** without version (enables rotation)
6. **Set expiration dates** for secrets and automate rotation
7. **Use separate Key Vaults** for dev/test/prod environments
8. **Monitor Key Vault** with diagnostic logs and alerts

## Cleanup

```bash
az group delete -y -n labs-keyvault-az204 --no-wait
```

## Additional Resources

- [Azure Key Vault documentation](https://docs.microsoft.com/en-us/azure/key-vault/)
- [Key Vault SDK for .NET](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/security.keyvault.secrets-readme)
- [Managed identities for Azure resources](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
