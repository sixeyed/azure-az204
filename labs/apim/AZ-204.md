# Azure API Management - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Connect to and Consume Azure Services (20-25%)

This lab extends the basic API Management exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [API Management lab](README.md) first to understand fundamental APIM operations.

## AZ-204 Exam Skills Covered

- Create an Azure API Management instance
- Create and document APIs
- Configure authentication and authorization for APIs
- Implement policies for APIs (transformation, caching, rate limiting)
- API versioning and revisions
- Developer portal configuration

## Exercise 1: Create API Management Instance

**AZ-204 Topic:** Understand APIM tiers and instance creation.

### APIM Service Tiers

| Tier | Use Case | Features | SLA |
|------|----------|----------|-----|
| **Consumption** | Serverless, pay-per-call | Auto-scaling, low cost | 99.95% |
| **Developer** | Dev/test | No SLA, limited capacity | None |
| **Basic** | Small production | 99.95% SLA | 99.95% |
| **Standard** | Medium production | VNet, multi-region cache | 99.95% |
| **Premium** | Enterprise | Multi-region, VNet, high capacity | 99.99% |

### Create APIM Instance

```bash
az group create -n labs-apim-az204 --tags courselabs=azure -l eastus

# Create APIM instance (Consumption tier - fastest to provision)
az apim create \
  -g labs-apim-az204 \
  -n <apim-name> \
  --publisher-email admin@contoso.com \
  --publisher-name "Contoso" \
  --sku-name Consumption \
  -l eastus
```

> **Note:** Standard and Premium tiers can take 30-45 minutes to provision. Use Consumption or Developer for labs.

Get APIM details:

```bash
az apim show \
  -g labs-apim-az204 \
  -n <apim-name> \
  --query '{name:name, gatewayUrl:gatewayUrl, portalUrl:portalUrl}' \
  -o table
```

> **AZ-204 Exam Tip:** APIM components:
> - **API Gateway**: Accepts API calls, enforces policies, routes to backends
> - **Azure Portal**: Admin interface for configuration
> - **Developer Portal**: Self-service portal for API consumers
> - **Management API**: Programmatic configuration

## Exercise 2: Import and Create APIs

**AZ-204 Topic:** Multiple ways to add APIs to APIM.

### Import API from OpenAPI Specification

```bash
# Import from OpenAPI spec URL
az apim api import \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --path weather \
  --api-id weather-api \
  --display-name "Weather API" \
  --specification-format OpenApiJson \
  --specification-url "https://raw.githubusercontent.com/APIs-guru/openapi-directory/main/APIs/weatherbit.io/2.0.0/openapi.yaml"
```

### Manually Define API

```bash
# Create API
az apim api create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --path orders \
  --display-name "Orders API" \
  --service-url "https://mybackend.azurewebsites.net" \
  --protocols https

# Add operation
az apim api operation create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --url-template "/orders" \
  --method GET \
  --display-name "Get Orders" \
  --operation-id get-orders

az apim api operation create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --url-template "/orders/{id}" \
  --method GET \
  --display-name "Get Order by ID" \
  --operation-id get-order \
  --template-parameters name=id description="Order ID" type=string required=true
```

ðŸ“‹ Add a POST operation to create a new order.

<details>
  <summary>Not sure how?</summary>

```bash
az apim api operation create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --url-template "/orders" \
  --method POST \
  --display-name "Create Order" \
  --operation-id create-order
```

</details><br/>

## Exercise 3: API Policies

**AZ-204 Critical Topic:** Policies transform requests/responses and enforce rules.

### Policy Sections

Policies execute in this order:
1. **Inbound**: Before request forwarded to backend
2. **Backend**: Control backend invocation
3. **Outbound**: Before response sent to client
4. **On-error**: When error occurs

### Common Policy Examples

**Rate Limiting:**

```xml
<policies>
    <inbound>
        <rate-limit calls="5" renewal-period="60" />
        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
```

**IP Filtering:**

```xml
<inbound>
    <ip-filter action="allow">
        <address>13.66.201.169</address>
        <address-range from="13.66.140.128" to="13.66.140.143" />
    </ip-filter>
</inbound>
```

**Caching:**

```xml
<inbound>
    <cache-lookup vary-by-developer="false" vary-by-developer-groups="false">
        <vary-by-query-parameter>category</vary-by-query-parameter>
    </cache-lookup>
</inbound>
<outbound>
    <cache-store duration="3600" />
</outbound>
```

**Request/Response Transformation:**

```xml
<inbound>
    <!-- Add header to request -->
    <set-header name="X-API-Version" exists-action="override">
        <value>v1</value>
    </set-header>

    <!-- Rewrite URL -->
    <rewrite-uri template="/api/v2{remainder}" />

    <!-- Set backend URL -->
    <set-backend-service base-url="https://newbackend.azurewebsites.net" />
</inbound>
<outbound>
    <!-- Remove header from response -->
    <set-header name="X-Powered-By" exists-action="delete" />

    <!-- Transform JSON response -->
    <find-and-replace from="Microsoft" to="Contoso" />
</outbound>
```

**CORS:**

```xml
<inbound>
    <cors allow-credentials="true">
        <allowed-origins>
            <origin>https://www.contoso.com</origin>
            <origin>https://app.contoso.com</origin>
        </allowed-origins>
        <allowed-methods>
            <method>GET</method>
            <method>POST</method>
        </allowed-methods>
        <allowed-headers>
            <header>*</header>
        </allowed-headers>
    </cors>
</inbound>
```

### Apply Policy via CLI

```bash
# Create policy file
cat > policy.xml << 'EOF'
<policies>
    <inbound>
        <rate-limit calls="10" renewal-period="60" />
        <set-header name="X-API-Key" exists-action="override">
            <value>secret-key-12345</value>
        </set-header>
        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <set-header name="X-Powered-By" exists-action="delete" />
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
EOF

# Apply to API
az apim api update \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --if-match "*"
```

> **AZ-204 Exam Tip:** Policy scope hierarchy (most to least specific):
> 1. Operation level
> 2. API level
> 3. Product level (applies to all APIs in product)
> 4. All APIs (global)
>
> Use `<base />` to inherit parent policies.

## Exercise 4: Authentication and Authorization

**AZ-204 Critical Topic:** Secure API access.

### Subscription Keys (Built-in)

APIM automatically generates subscription keys.

```bash
# List subscriptions
az apim subscription list \
  -g labs-apim-az204 \
  --service-name <apim-name>

# Create subscription
az apim subscription create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --subscription-id mobile-app \
  --display-name "Mobile App Subscription" \
  --scope "/apis/orders-api"
```

Call API with subscription key:

```bash
# Header authentication
curl -H "Ocp-Apim-Subscription-Key: <subscription-key>" \
  https://<apim-name>.azure-api.net/orders

# Query string authentication
curl "https://<apim-name>.azure-api.net/orders?subscription-key=<subscription-key>"
```

### Validate JWT Token

```xml
<inbound>
    <validate-jwt header-name="Authorization" failed-validation-httpcode="401">
        <openid-config url="https://login.microsoftonline.com/{tenant-id}/v2.0/.well-known/openid-configuration" />
        <required-claims>
            <claim name="aud">
                <value>api://myapi</value>
            </claim>
        </required-claims>
    </validate-jwt>
</inbound>
```

### Client Certificate Authentication

```xml
<inbound>
    <choose>
        <when condition="@(context.Request.Certificate == null || !context.Request.Certificate.Verify()  || context.Request.Certificate.Thumbprint != "DESIRED-THUMBPRINT")">
            <return-response>
                <set-status code="403" reason="Invalid client certificate" />
            </return-response>
        </when>
    </choose>
</inbound>
```

### OAuth 2.0 / Azure AD

```xml
<inbound>
    <validate-jwt header-name="Authorization" failed-validation-httpcode="401">
        <openid-config url="https://login.microsoftonline.com/{tenant-id}/v2.0/.well-known/openid-configuration" />
        <audiences>
            <audience>api://orders-api</audience>
        </audiences>
        <issuers>
            <issuer>https://sts.windows.net/{tenant-id}/</issuer>
        </issuers>
        <required-claims>
            <claim name="roles" match="any">
                <value>OrderReader</value>
                <value>OrderWriter</value>
            </claim>
        </required-claims>
    </validate-jwt>
</inbound>
```

## Exercise 5: API Versioning

**AZ-204 Topic:** Manage breaking changes with versioning.

### Versioning Schemes

1. **Path-based**: `/v1/orders`, `/v2/orders`
2. **Query string**: `/orders?api-version=1`
3. **Header**: `Api-Version: 1`

### Create Version Set

```bash
# Create version set
az apim api versionset create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --version-set-id orders-versions \
  --display-name "Orders API Versions" \
  --versioning-scheme Segment
```

### Create Versioned APIs

```bash
# Create v1
az apim api create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api-v1 \
  --path orders/v1 \
  --display-name "Orders API v1" \
  --service-url "https://backend-v1.azurewebsites.net" \
  --protocols https \
  --api-version v1 \
  --api-version-set-id orders-versions

# Create v2
az apim api create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api-v2 \
  --path orders/v2 \
  --display-name "Orders API v2" \
  --service-url "https://backend-v2.azurewebsites.net" \
  --protocols https \
  --api-version v2 \
  --api-version-set-id orders-versions
```

> **AZ-204 Exam Tip:** Versioning vs Revisions:
> - **Versions**: Breaking changes, different paths/parameters
> - **Revisions**: Non-breaking changes, can be rolled back

## Exercise 6: API Revisions

**AZ-204 Topic:** Safely test changes before making them current.

### Create Revision

```bash
# Create new revision
az apim api revision create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --api-revision 2 \
  --api-revision-description "Added filtering support"
```

Access revision:

```
https://<apim-name>.azure-api.net/orders;rev=2
```

Make revision current:

```bash
az apim api release create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --api-id orders-api \
  --api-revision 2 \
  --notes "Promoted revision 2 to current"
```

## Exercise 7: Products

**AZ-204 Topic:** Group APIs into products for access control.

### Create Product

```bash
# Create product
az apim product create \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --product-id premium \
  --product-name "Premium Plan" \
  --description "Full API access with higher rate limits" \
  --subscription-required true \
  --approval-required true \
  --state published

# Add API to product
az apim product api add \
  -g labs-apim-az204 \
  --service-name <apim-name> \
  --product-id premium \
  --api-id orders-api
```

Apply product-level policy:

```xml
<policies>
    <inbound>
        <rate-limit calls="1000" renewal-period="3600" />
        <quota calls="10000" renewal-period="86400" />
        <base />
    </inbound>
</policies>
```

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **APIM Components:**
   - API Gateway (request handling)
   - Management plane (configuration)
   - Developer portal (self-service)
   - Azure portal (admin)

2. **Policy Execution Order:**
   - Inbound â†’ Backend â†’ Outbound â†’ On-error
   - Scope: Global â†’ Product â†’ API â†’ Operation

3. **Authentication Methods:**
   - Subscription keys (built-in)
   - OAuth 2.0 / Azure AD
   - Client certificates
   - JWT validation

4. **Versioning vs Revisions:**
   - **Versions**: Breaking changes, new URL
   - **Revisions**: Non-breaking, testing before promotion

5. **Common Policies:**
   - `rate-limit`, `quota`: Throttling
   - `cache-lookup`, `cache-store`: Caching
   - `validate-jwt`: Authentication
   - `set-header`, `rewrite-uri`: Transformation
   - `cors`: Cross-origin support
   - `ip-filter`: IP whitelisting/blacklisting

### Common Exam Scenarios

1. **Scenario:** Limit API calls to 100 per hour per user
   - **Solution:** `<rate-limit calls="100" renewal-period="3600" />`

2. **Scenario:** Cache GET requests for 1 hour
   - **Solution:** `<cache-lookup>` in inbound, `<cache-store duration="3600">` in outbound

3. **Scenario:** Validate Azure AD JWT tokens
   - **Solution:** `<validate-jwt>` policy with OpenID config URL

4. **Scenario:** Deploy breaking API changes
   - **Solution:** Create new version with different path

5. **Scenario:** Test changes before going live
   - **Solution:** Create new revision, test with `;rev=N`, then promote

## Best Practices

1. **Use products** to group APIs and apply common policies
2. **Enable caching** for read-heavy APIs
3. **Implement rate limiting** to protect backend services
4. **Use revisions** for safe testing before deployment
5. **Version APIs** for breaking changes
6. **Validate JWT tokens** for secure APIs
7. **Monitor usage** through Application Insights
8. **Document APIs** in Developer Portal

## Cleanup

```bash
az group delete -y -n labs-apim-az204 --no-wait
```

## Additional Resources

- [Azure API Management documentation](https://docs.microsoft.com/en-us/azure/api-management/)
- [API Management policies](https://docs.microsoft.com/en-us/azure/api-management/api-management-policies)
- [API versioning](https://docs.microsoft.com/en-us/azure/api-management/api-management-versions)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
