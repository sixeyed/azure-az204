# Azure Storage Accounts - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Develop for Azure Storage (15-20%)

This lab extends the basic storage exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [Storage lab](README.md) first to understand fundamental storage account operations.

## AZ-204 Exam Skills Covered

- Create and configure storage accounts
- Understand storage account types and performance tiers
- Configure replication options (LRS, ZRS, GRS, RA-GRS)
- Manage access keys and shared access signatures (SAS)
- Configure storage firewalls and virtual networks
- Implement encryption at rest and in transit
- Configure managed identity access to storage

## Exercise 1: Storage Account Types and Performance Tiers

**AZ-204 Critical Topic:** Understanding the differences between storage account types is essential for the exam.

### Storage Account Types

```bash
# Create resource group
az group create -n labs-storage-az204 --tags courselabs=azure -l eastus

# Standard general-purpose v2 (most common, supports all services)
az storage account create \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --sku Standard_LRS \
  --kind StorageV2 \
  --access-tier Hot

# Premium block blob storage (high performance, SSD-based)
az storage account create \
  -g labs-storage-az204 \
  -n <storage-name-premium> \
  --sku Premium_LRS \
  --kind BlockBlobStorage

# Premium file shares (high performance file shares)
az storage account create \
  -g labs-storage-az204 \
  -n <storage-name-files> \
  --sku Premium_LRS \
  --kind FileStorage
```

ðŸ“‹ Create a Standard general-purpose v2 storage account with ZRS replication and Cool access tier.

<details>
  <summary>Not sure how?</summary>

```bash
az storage account create \
  -g labs-storage-az204 \
  -n <storage-name-cool> \
  --sku Standard_ZRS \
  --kind StorageV2 \
  --access-tier Cool
```

</details><br/>

> **AZ-204 Exam Tip:** Storage account kinds:
> - **StorageV2** (General-purpose v2): Recommended for most scenarios, supports all storage services (blobs, files, queues, tables)
> - **BlockBlobStorage**: Premium performance for block blobs and append blobs only
> - **FileStorage**: Premium performance for file shares only
> - **BlobStorage**: Legacy, use StorageV2 instead
> - **StorageV1**: Legacy general-purpose v1, lacks modern features

### Performance Tiers

```bash
# Check storage account properties
az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query '{name:name, kind:kind, sku:sku.name, accessTier:accessTier, location:location}'
```

> **AZ-204 Exam Tip:** Performance tiers:
> - **Standard**: Uses HDD, supports all redundancy options, lower cost
> - **Premium**: Uses SSD, only supports LRS and ZRS, higher cost, lower latency
> - Premium storage accounts are specialized by service (BlockBlobStorage, FileStorage)

## Exercise 2: Replication Options

**AZ-204 Critical Topic:** Understanding replication strategies for durability and availability.

### Replication Types

```bash
# LRS (Locally Redundant Storage) - 3 copies in single datacenter
az storage account create \
  -g labs-storage-az204 \
  -n <storage-lrs> \
  --sku Standard_LRS \
  --kind StorageV2

# ZRS (Zone-Redundant Storage) - 3 copies across availability zones
az storage account create \
  -g labs-storage-az204 \
  -n <storage-zrs> \
  --sku Standard_ZRS \
  --kind StorageV2

# GRS (Geo-Redundant Storage) - 6 copies (3 local + 3 in paired region)
az storage account create \
  -g labs-storage-az204 \
  -n <storage-grs> \
  --sku Standard_GRS \
  --kind StorageV2

# RA-GRS (Read-Access Geo-Redundant Storage) - GRS with read access to secondary
az storage account create \
  -g labs-storage-az204 \
  -n <storage-ragrs> \
  --sku Standard_RAGRS \
  --kind StorageV2
```

Check replication status:

```bash
az storage account show \
  -g labs-storage-az204 \
  -n <storage-grs> \
  --query '{name:name, sku:sku.name, primaryLocation:primaryLocation, secondaryLocation:secondaryLocation}'
```

ðŸ“‹ Create a GZRS (Geo-Zone-Redundant Storage) account for maximum durability.

<details>
  <summary>Not sure how?</summary>

```bash
az storage account create \
  -g labs-storage-az204 \
  -n <storage-gzrs> \
  --sku Standard_GZRS \
  --kind StorageV2
```

</details><br/>

> **AZ-204 Exam Tip:** Replication comparison:
> - **LRS**: 11 nines durability (99.999999999%), cheapest, protects against drive/rack failures
> - **ZRS**: 12 nines durability, protects against datacenter failures, available in select regions
> - **GRS**: 16 nines durability, protects against regional failures, secondary is read-only during failover
> - **RA-GRS**: 16 nines durability, read access to secondary region anytime
> - **GZRS**: 16 nines durability, combines ZRS in primary with GRS replication
> - **RA-GZRS**: GZRS with read access to secondary region

### Failover and Endpoints

For RA-GRS storage accounts:

```bash
# Get primary and secondary endpoints
az storage account show \
  -g labs-storage-az204 \
  -n <storage-ragrs> \
  --query 'primaryEndpoints'

az storage account show \
  -g labs-storage-az204 \
  -n <storage-ragrs> \
  --query 'secondaryEndpoints'
```

> **AZ-204 Exam Tip:** Secondary endpoints use `-secondary` suffix:
> - Primary: `https://mystorageacct.blob.core.windows.net`
> - Secondary: `https://mystorageacct-secondary.blob.core.windows.net`

## Exercise 3: Access Keys vs SAS Tokens

**AZ-204 Critical Topic:** Understanding authentication and authorization methods.

### Access Keys

```bash
# List access keys
az storage account keys list \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  -o table

# Get specific key
STORAGE_KEY=$(az storage account keys list \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query '[0].value' -o tsv)

echo "Storage Key: $STORAGE_KEY"
```

Rotate access keys:

```bash
# Regenerate key1
az storage account keys renew \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --key key1

# Verify keys changed
az storage account keys list \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  -o table
```

> **AZ-204 Exam Tip:** Access keys provide full access to storage account. Best practices:
> - Use two keys (key1, key2) to enable rotation without downtime
> - Rotate keys regularly
> - Store keys in Azure Key Vault, never in code
> - Prefer SAS tokens or managed identities over access keys

### Shared Access Signatures (SAS)

Create account-level SAS token:

```bash
# Get account key
ACCOUNT_KEY=$(az storage account keys list \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query '[0].value' -o tsv)

# Generate account SAS (access to multiple services)
az storage account generate-sas \
  --account-name <storage-name-gpv2> \
  --account-key $ACCOUNT_KEY \
  --services bfqt \
  --resource-types sco \
  --permissions rwdlacup \
  --expiry $(date -u -d "8 hours" '+%Y-%m-%dT%H:%MZ') \
  --https-only
```

Service-level SAS for blob container:

```bash
# Create container first
az storage container create \
  --account-name <storage-name-gpv2> \
  --account-key $ACCOUNT_KEY \
  --name testcontainer

# Generate service SAS for container
az storage container generate-sas \
  --account-name <storage-name-gpv2> \
  --account-key $ACCOUNT_KEY \
  --name testcontainer \
  --permissions rl \
  --expiry $(date -u -d "4 hours" '+%Y-%m-%dT%H:%MZ') \
  --https-only
```

ðŸ“‹ Create a SAS token with read-only access, IP restriction to 203.0.113.5, valid for 2 hours.

<details>
  <summary>Not sure how?</summary>

```bash
az storage container generate-sas \
  --account-name <storage-name-gpv2> \
  --account-key $ACCOUNT_KEY \
  --name testcontainer \
  --permissions r \
  --expiry $(date -u -d "2 hours" '+%Y-%m-%dT%H:%MZ') \
  --ip "203.0.113.5" \
  --https-only
```

</details><br/>

> **AZ-204 Exam Tip:** SAS token types:
> - **Account SAS**: Access to one or more storage services, created with account key
> - **Service SAS**: Access to specific service (blob, file, queue, table), created with account key
> - **User delegation SAS**: Secured with Azure AD credentials (most secure), only for blob storage
>
> SAS permissions:
> - **r**: Read, **w**: Write, **d**: Delete, **l**: List, **a**: Add, **c**: Create, **u**: Update, **p**: Process

### User Delegation SAS (Most Secure)

```bash
# Assign yourself Storage Blob Data Contributor role
STORAGE_ID=$(az storage account show -g labs-storage-az204 -n <storage-name-gpv2> --query id -o tsv)
az role assignment create \
  --role "Storage Blob Data Contributor" \
  --assignee <your-user-principal-name> \
  --scope $STORAGE_ID

# Generate user delegation SAS (using Azure AD credentials)
az storage container generate-sas \
  --account-name <storage-name-gpv2> \
  --name testcontainer \
  --permissions rl \
  --expiry $(date -u -d "4 hours" '+%Y-%m-%dT%H:%MZ') \
  --auth-mode login \
  --as-user \
  --https-only
```

> **AZ-204 Exam Tip:** User delegation SAS advantages:
> - Secured with Azure AD credentials (no account keys exposed)
> - Can be revoked by revoking the user's permissions
> - Maximum expiry of 7 days
> - Only available for Blob storage

## Exercise 4: Storage Account Endpoints

**AZ-204 Topic:** Understanding service endpoints.

### Default Endpoints

```bash
# View all endpoints
az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query 'primaryEndpoints'
```

Standard endpoints format:
- Blob: `https://<storage-name>.blob.core.windows.net`
- Queue: `https://<storage-name>.queue.core.windows.net`
- Table: `https://<storage-name>.table.core.windows.net`
- File: `https://<storage-name>.file.core.windows.net`
- Web: `https://<storage-name>.z13.web.core.windows.net`
- DFS (Data Lake): `https://<storage-name>.dfs.core.windows.net`

### Custom Domain

```bash
# Configure custom domain (requires CNAME record)
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --custom-domain "blobs.contoso.com"
```

> **AZ-204 Exam Tip:** Custom domain requirements:
> - Create CNAME record pointing to storage blob endpoint
> - HTTPS with custom domain requires Azure CDN
> - Only supported for Blob and Static Website endpoints

## Exercise 5: Firewalls and Virtual Networks

**AZ-204 Security Topic:** Network security for storage accounts.

### Configure Network Rules

```bash
# Deny all network access by default
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --default-action Deny

# Allow specific IP address
az storage account network-rule add \
  -g labs-storage-az204 \
  --account-name <storage-name-gpv2> \
  --ip-address 203.0.113.5

# Allow IP range (CIDR notation)
az storage account network-rule add \
  -g labs-storage-az204 \
  --account-name <storage-name-gpv2> \
  --ip-address 10.0.0.0/24
```

ðŸ“‹ List all network rules for the storage account.

<details>
  <summary>Not sure how?</summary>

```bash
az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query 'networkRuleSet'
```

</details><br/>

### Virtual Network Integration

```bash
# Create VNet and subnet
az network vnet create \
  -g labs-storage-az204 \
  -n storage-vnet \
  --address-prefix 10.0.0.0/16 \
  --subnet-name storage-subnet \
  --subnet-prefix 10.0.1.0/24

# Enable service endpoint for Microsoft.Storage
az network vnet subnet update \
  -g labs-storage-az204 \
  --vnet-name storage-vnet \
  --name storage-subnet \
  --service-endpoints Microsoft.Storage

# Add VNet rule to storage account
az storage account network-rule add \
  -g labs-storage-az204 \
  --account-name <storage-name-gpv2> \
  --vnet-name storage-vnet \
  --subnet storage-subnet
```

### Bypass Azure Services

```bash
# Allow trusted Azure services to bypass firewall
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --bypass AzureServices
```

> **AZ-204 Exam Tip:** Network security options:
> - **Default action**: Allow or Deny
> - **IP rules**: Allow specific public IPs/ranges
> - **Virtual network rules**: Allow specific subnets (requires service endpoint)
> - **Bypass**: AzureServices, Logging, Metrics
> - Resource instances rules: Allow specific Azure resource instances

### Private Endpoints

```bash
# Create private endpoint
az network private-endpoint create \
  -g labs-storage-az204 \
  -n storage-private-endpoint \
  --vnet-name storage-vnet \
  --subnet storage-subnet \
  --private-connection-resource-id $STORAGE_ID \
  --group-id blob \
  --connection-name storage-private-connection
```

> **AZ-204 Exam Tip:** Private endpoints provide private IP access to storage from VNet, eliminating exposure to public internet. Each storage service (blob, file, queue, table) requires separate private endpoint.

## Exercise 6: Encryption at Rest and in Transit

**AZ-204 Security Topic:** Data encryption.

### Encryption at Rest

```bash
# View encryption settings (enabled by default)
az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query 'encryption'
```

> **AZ-204 Exam Tip:** Encryption at rest:
> - **Microsoft-managed keys (MMK)**: Default, managed by Microsoft
> - **Customer-managed keys (CMK)**: Keys stored in Azure Key Vault, customer controls rotation
> - **Customer-provided keys (CPK)**: Customer provides key with each request (Blob/File only)
> - All Azure Storage data is encrypted at rest using 256-bit AES encryption

### Customer-Managed Keys

```bash
# Create Key Vault
az keyvault create \
  -g labs-storage-az204 \
  -n <keyvault-name> \
  --enable-soft-delete true \
  --enable-purge-protection true

# Create key
az keyvault key create \
  --vault-name <keyvault-name> \
  --name storage-encryption-key \
  --kty RSA \
  --size 2048

# Enable system-assigned managed identity for storage account
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --assign-identity

# Get storage account identity
STORAGE_IDENTITY=$(az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query 'identity.principalId' -o tsv)

# Grant Key Vault permissions to storage account
az keyvault set-policy \
  --name <keyvault-name> \
  --object-id $STORAGE_IDENTITY \
  --key-permissions get unwrapKey wrapKey

# Configure storage account to use customer-managed key
KEY_URI=$(az keyvault key show --vault-name <keyvault-name> --name storage-encryption-key --query 'key.kid' -o tsv)
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --encryption-key-source Microsoft.Keyvault \
  --encryption-key-vault $KEY_URI
```

### Encryption in Transit

```bash
# Require secure transfer (HTTPS only)
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --https-only true

# Set minimum TLS version
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --min-tls-version TLS1_2
```

> **AZ-204 Exam Tip:**
> - Always enable "Secure transfer required" (HTTPS only) for production
> - Set minimum TLS version to TLS 1.2
> - Data in transit is encrypted using TLS/SSL
> - SMB 3.0 provides encryption for Azure Files

## Exercise 7: Managed Identity Access

**AZ-204 Critical Topic:** Secure access without credentials in code.

### Enable System-Assigned Managed Identity

```bash
# Enable managed identity on storage account
az storage account update \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --assign-identity

# Get identity
STORAGE_IDENTITY=$(az storage account show \
  -g labs-storage-az204 \
  -n <storage-name-gpv2> \
  --query 'identity.principalId' -o tsv)

echo "Storage Account Identity: $STORAGE_IDENTITY"
```

### Grant Storage Access to App Service

```bash
# Create App Service
az appservice plan create \
  -g labs-storage-az204 \
  -n storage-app-plan \
  --sku B1

az webapp create \
  -g labs-storage-az204 \
  -p storage-app-plan \
  -n <webapp-name> \
  --runtime "DOTNET:6.0" \
  --assign-identity [system]

# Get app identity
APP_IDENTITY=$(az webapp identity show \
  -g labs-storage-az204 \
  -n <webapp-name> \
  --query principalId -o tsv)

# Grant app Storage Blob Data Contributor role
az role assignment create \
  --role "Storage Blob Data Contributor" \
  --assignee $APP_IDENTITY \
  --scope $STORAGE_ID
```

ðŸ“‹ Grant the app "Storage Queue Data Contributor" role as well.

<details>
  <summary>Not sure how?</summary>

```bash
az role assignment create \
  --role "Storage Queue Data Contributor" \
  --assignee $APP_IDENTITY \
  --scope $STORAGE_ID
```

</details><br/>

> **AZ-204 Exam Tip:** Storage RBAC roles:
> - **Storage Account Contributor**: Manage storage accounts (control plane)
> - **Storage Blob Data Owner**: Full access to blob containers and data
> - **Storage Blob Data Contributor**: Read, write, delete blobs
> - **Storage Blob Data Reader**: Read and list blobs
> - **Storage Queue Data Contributor**: Read, write, delete queue messages
> - **Storage Queue Data Reader**: Read and peek queue messages
> - **Storage Table Data Contributor**: Read, write, delete table data
> - **Storage Table Data Reader**: Read table data

### Using Managed Identity in Code

**.NET Example:**

```csharp
using Azure.Identity;
using Azure.Storage.Blobs;

// Use DefaultAzureCredential (works with managed identity)
var blobServiceClient = new BlobServiceClient(
    new Uri("https://<storage-name-gpv2>.blob.core.windows.net"),
    new DefaultAzureCredential());

// Access blobs
var containerClient = blobServiceClient.GetBlobContainerClient("mycontainer");
await containerClient.CreateIfNotExistsAsync();

var blobClient = containerClient.GetBlobClient("myblob.txt");
await blobClient.UploadAsync(stream);
```

**Python Example:**

```python
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

credential = DefaultAzureCredential()
blob_service_client = BlobServiceClient(
    account_url="https://<storage-name-gpv2>.blob.core.windows.net",
    credential=credential
)

container_client = blob_service_client.get_container_client("mycontainer")
blob_client = container_client.get_blob_client("myblob.txt")
```

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **Storage Account Types:**
   - **General-purpose v2 (StorageV2)**: All services, most features, recommended
   - **Premium Block Blob**: High performance, SSD, block blobs only
   - **Premium File Storage**: High performance file shares
   - **Legacy types**: Avoid in new implementations

2. **Performance Tiers:**
   - **Standard**: HDD-based, lower cost, all redundancy options
   - **Premium**: SSD-based, higher cost, LRS/ZRS only, single-digit millisecond latency

3. **Replication Options:**
   - **LRS**: 3 copies, single datacenter, 11 nines durability
   - **ZRS**: 3 copies across zones, 12 nines durability
   - **GRS**: 6 copies across regions, 16 nines durability
   - **RA-GRS**: GRS + read access to secondary
   - **GZRS/RA-GZRS**: Combines zone and geo redundancy

4. **Access Methods:**
   - **Access keys**: Full access, rotate regularly, store in Key Vault
   - **SAS tokens**: Scoped access, time-limited, revocable
   - **Azure AD (managed identity)**: Most secure, no credentials in code
   - **Anonymous access**: Public read access to blobs

5. **Security:**
   - **Encryption at rest**: Always on, MMK or CMK
   - **Encryption in transit**: HTTPS only, TLS 1.2+
   - **Network security**: Firewall rules, VNet integration, private endpoints
   - **Authorization**: Azure AD preferred over shared keys

6. **Endpoints:**
   - Each service has unique endpoint
   - Secondary endpoints for RA-GRS/RA-GZRS
   - Custom domains supported with CNAME

### Common Exam Scenarios

1. **Scenario:** Need maximum availability and read performance across regions
   - **Solution:** Use RA-GZRS replication, access secondary endpoint for reads

2. **Scenario:** Secure storage access from App Service without credentials
   - **Solution:** Enable managed identity on app, grant Storage Blob Data Contributor role

3. **Scenario:** Allow access from on-premises network only
   - **Solution:** Configure storage firewall with IP rules for on-premises public IPs

4. **Scenario:** Prevent data exfiltration to internet
   - **Solution:** Use private endpoints and disable public access

5. **Scenario:** Provide temporary upload access to external partners
   - **Solution:** Generate service SAS with write-only permissions and short expiry

6. **Scenario:** Comply with data residency requiring encryption key control
   - **Solution:** Use customer-managed keys stored in Azure Key Vault

7. **Scenario:** High-performance application requires single-digit latency
   - **Solution:** Use Premium Block Blob Storage or Premium File Storage

## Best Practices

1. **Always use HTTPS** - Enable "Secure transfer required"
2. **Prefer managed identity** over access keys when possible
3. **Use General-purpose v2** for new storage accounts
4. **Enable soft delete** for blob and file data protection
5. **Configure firewall rules** to limit network access
6. **Use customer-managed keys** for compliance requirements
7. **Monitor storage metrics** for performance and security
8. **Set up lifecycle management** to optimize costs
9. **Use private endpoints** for VNet isolation
10. **Regularly rotate access keys** using Key Vault

## Cleanup

```bash
az group delete -y -n labs-storage-az204 --no-wait
```

## Additional Resources

- [Azure Storage documentation](https://docs.microsoft.com/en-us/azure/storage/)
- [Storage account overview](https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview)
- [Azure Storage security guide](https://docs.microsoft.com/en-us/azure/storage/common/storage-security-guide)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
