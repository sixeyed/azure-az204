# Azure App Service - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Implement Azure App Service Web Apps (15-20%)

This lab extends the basic App Service exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [App Service lab](README.md) first to understand fundamental App Service operations.

## AZ-204 Exam Skills Covered

- Create and configure Azure App Service web apps
- Implement deployment slots for staging and production
- Configure App Service settings and connection strings
- Scale App Service apps (manual and auto-scale)
- Configure custom domains and SSL certificates
- Implement diagnostic logging
- Deploy applications using various methods (Git, ZIP, Docker, FTP)
- Work with WebJobs for background processing

## Exercise 1: App Service Plans and Tiers

**AZ-204 Critical Topic:** Understanding App Service Plan tiers and their capabilities.

### App Service Plan Tiers

**Shared Compute:**
- **Free (F1)**: 60 minutes/day compute, 1 GB disk, no custom domains/SSL
- **Shared (D1)**: 240 minutes/day compute, 1 GB disk, custom domains

**Dedicated Compute:**
- **Basic (B1, B2, B3)**: Custom domains, SSL, manual scaling, 10 GB disk
- **Standard (S1, S2, S3)**: Auto-scale, staging slots, 50 GB disk, backup/restore
- **Premium (P1v2, P2v2, P3v2)**: Enhanced performance, 250 GB disk, VNet integration
- **Premium v3 (P1v3, P2v3, P3v3)**: Latest hardware, faster scaling

**Isolated:**
- **Isolated (I1, I2, I3)**: Private, dedicated Azure Virtual Network, maximum scale

### Create App Service Plans

```bash
az group create -n labs-appservice-az204 --tags courselabs=azure -l eastus

# Free tier (for development/testing)
az appservice plan create \
  -g labs-appservice-az204 \
  -n free-plan \
  --sku F1

# Standard tier (production workloads)
az appservice plan create \
  -g labs-appservice-az204 \
  -n standard-plan \
  --sku S1 \
  --location eastus
```

> **AZ-204 Exam Tip:** Key tier differences:
> - **Free/Shared**: No deployment slots, no auto-scale, no custom SSL
> - **Basic**: Custom domains and SSL, but no deployment slots
> - **Standard+**: All production features including deployment slots and auto-scale
> - **Premium**: VNet integration, enhanced performance
> - **Isolated**: Dedicated environment, maximum isolation and scale

### Scale App Service Plan

```bash
# Scale up (change tier)
az appservice plan update \
  -g labs-appservice-az204 \
  -n standard-plan \
  --sku S2

# Scale out (increase instance count)
az appservice plan update \
  -g labs-appservice-az204 \
  -n standard-plan \
  --number-of-workers 3
```

## Exercise 2: Deployment Methods

**AZ-204 Critical:** Multiple deployment options for different scenarios.

### Git Deployment (Local Git)

```bash
# Create web app
az webapp create \
  -g labs-appservice-az204 \
  -p standard-plan \
  -n <webapp-name> \
  --runtime "NODE:18-lts"

# Configure local Git deployment
az webapp deployment source config-local-git \
  -g labs-appservice-az204 \
  -n <webapp-name>

# Get deployment URL
az webapp deployment source show \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --query url -o tsv

# Set deployment credentials
az webapp deployment user set \
  --user-name <username> \
  --password <password>

# Push code
git remote add azure <git-url>
git push azure main:master
```

### ZIP Deployment

```bash
# Create deployment package
zip -r app.zip . -x "*.git*"

# Deploy ZIP file
az webapp deployment source config-zip \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --src app.zip
```

### Container Deployment (Docker)

```bash
# Create web app from Docker image
az webapp create \
  -g labs-appservice-az204 \
  -p standard-plan \
  -n <webapp-name> \
  --deployment-container-image-name nginx:latest

# Configure custom container
az webapp config container set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --docker-custom-image-name <registry>/<image>:<tag> \
  --docker-registry-server-url https://<registry>.azurecr.io \
  --docker-registry-server-user <username> \
  --docker-registry-server-password <password>

# Enable continuous deployment from registry
az webapp deployment container config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --enable-cd true
```

### FTP Deployment

```bash
# Get FTP deployment credentials
az webapp deployment list-publishing-credentials \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --query "{ftpUrl:scmUri, username:publishingUserName, password:publishingPassword}"
```

> **AZ-204 Exam Tip:** Deployment method comparison:
> - **Local Git**: Full Git history, requires credentials
> - **GitHub/Azure DevOps**: CI/CD integration, recommended for production
> - **ZIP**: Quick deployment, no Git history
> - **Docker**: Containerized apps, supports multi-container
> - **FTP**: Legacy support, not recommended for production

## Exercise 3: Deployment Slots

**AZ-204 Critical Topic:** Deployment slots enable zero-downtime deployments and testing.

### Create and Configure Deployment Slots

```bash
# Create web app (requires Standard tier or higher)
az webapp create \
  -g labs-appservice-az204 \
  -p standard-plan \
  -n <webapp-name> \
  --runtime "DOTNET:8.0"

# Create staging slot
az webapp deployment slot create \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging

# Create development slot
az webapp deployment slot create \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot dev

# List all slots
az webapp deployment slot list \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  -o table
```

### Slot-Specific Settings

**Two types of settings:**
1. **Slot settings**: Stay with the slot (don't swap)
2. **Non-slot settings**: Move with the app during swap (default)

```bash
# Configure app setting that swaps with deployment
az webapp config appsettings set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --settings Environment=Staging Version=1.0

# Configure slot-specific setting (doesn't swap)
az webapp config appsettings set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --settings DatabaseConnection=staging-db-conn \
  --slot-settings DatabaseConnection

# Configure connection string (slot-specific)
az webapp config connection-string set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --connection-string-type SQLAzure \
  --settings DefaultConnection="Server=staging-server.database.windows.net;Database=stagingdb;" \
  --slot-settings DefaultConnection
```

> **AZ-204 Exam Tip:** Common slot-specific settings:
> - Database connection strings (different per environment)
> - API endpoints (staging vs production)
> - Feature flags (enable features in staging first)
> - Application Insights keys (separate telemetry per slot)

### Swap Deployment Slots

```bash
# Swap staging to production
az webapp deployment slot swap \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --target-slot production

# Swap with preview (multi-phase swap)
az webapp deployment slot swap \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --target-slot production \
  --action preview

# Complete the swap
az webapp deployment slot swap \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --target-slot production \
  --action swap

# Cancel swap and rollback
az webapp deployment slot swap \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot staging \
  --target-slot production \
  --action reset
```

**Swap Process:**
1. Apply production settings to staging slot
2. Wait for staging instances to warm up
3. Swap routing rules
4. Production becomes staging (easy rollback)

ðŸ“‹ Create a slot named "testing" and configure it with slot-specific database connection.

<details>
  <summary>Not sure how?</summary>

```bash
# Create testing slot
az webapp deployment slot create \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot testing

# Configure slot-specific database connection
az webapp config connection-string set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --slot testing \
  --connection-string-type SQLAzure \
  --settings DefaultConnection="Server=test-server.database.windows.net;Database=testdb;" \
  --slot-settings DefaultConnection
```

</details><br/>

## Exercise 4: Auto-Scaling

**AZ-204 Critical Topic:** Automatically scale based on metrics or schedule.

### Enable Auto-Scale

```bash
# Create autoscale setting
az monitor autoscale create \
  -g labs-appservice-az204 \
  --resource <webapp-name> \
  --resource-type Microsoft.Web/serverFarms \
  --resource-group labs-appservice-az204 \
  --min-count 1 \
  --max-count 5 \
  --count 2 \
  -n autoscale-rules
```

### Metric-Based Rules

```bash
# Scale out when CPU > 75%
az monitor autoscale rule create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --condition "Percentage CPU > 75 avg 5m" \
  --scale out 1

# Scale in when CPU < 25%
az monitor autoscale rule create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --condition "Percentage CPU < 25 avg 5m" \
  --scale in 1

# Scale based on memory
az monitor autoscale rule create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --condition "MemoryPercentage > 80 avg 5m" \
  --scale out 1

# Scale based on HTTP queue length
az monitor autoscale rule create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --condition "HttpQueueLength > 100 avg 1m" \
  --scale out 2
```

### Schedule-Based Rules

```bash
# Scale up for business hours (Monday-Friday, 8 AM - 6 PM)
az monitor autoscale profile create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --name business-hours \
  --min-count 3 \
  --max-count 10 \
  --count 5 \
  --recurrence week Mon Tue Wed Thu Fri \
  --start "08:00" \
  --end "18:00" \
  --timezone "Pacific Standard Time"

# Scale down for off-hours
az monitor autoscale profile create \
  -g labs-appservice-az204 \
  --autoscale-name autoscale-rules \
  --name off-hours \
  --min-count 1 \
  --max-count 2 \
  --count 1 \
  --recurrence week Sat Sun
```

> **AZ-204 Exam Tip:** Auto-scale considerations:
> - Requires Standard tier or higher
> - Avoid flapping (scale in/out rapidly) with appropriate cool-down periods
> - Metrics: CPU, Memory, HTTP Queue Length, Data In/Out, Disk Queue Length
> - Custom metrics via Application Insights
> - Schedule-based useful for predictable load patterns

## Exercise 5: Custom Domains and SSL Certificates

**AZ-204 Topic:** Configure custom domains with SSL/TLS certificates.

### Add Custom Domain

```bash
# Get app verification ID for domain validation
az webapp show \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --query customDomainVerificationId -o tsv

# Add custom domain (after DNS configuration)
az webapp config hostname add \
  -g labs-appservice-az204 \
  --webapp-name <webapp-name> \
  --hostname www.contoso.com
```

**DNS Configuration Required:**
- **CNAME record**: `www` â†’ `<webapp-name>.azurewebsites.net`
- **TXT record**: `asuid.www` â†’ `<verification-id>` (for verification)

### SSL/TLS Certificates

```bash
# Upload certificate (PFX format)
az webapp config ssl upload \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --certificate-file mycert.pfx \
  --certificate-password <password>

# Bind SSL certificate to custom domain
az webapp config ssl bind \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --certificate-thumbprint <thumbprint> \
  --ssl-type SNI

# Create free managed certificate (requires Standard tier+)
az webapp config ssl create \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --hostname www.contoso.com

# Enforce HTTPS
az webapp update \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --https-only true

# Set minimum TLS version
az webapp config set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --min-tls-version 1.2
```

> **AZ-204 Exam Tip:** SSL certificate types:
> - **App Service Managed Certificate**: Free, auto-renewed, SNI SSL only
> - **App Service Certificate**: Purchased through Azure, stored in Key Vault
> - **Custom Certificate**: Upload PFX, supports IP-based SSL
> - **SNI SSL**: Multiple hostnames on same IP (recommended)
> - **IP-based SSL**: Dedicated IP address per certificate

## Exercise 6: App Service Configuration

**AZ-204 Critical Topic:** Application settings, connection strings, and environment variables.

### Application Settings

```bash
# Add application settings
az webapp config appsettings set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --settings \
    ApplicationName="MyApp" \
    Environment="Production" \
    MaxConnections="100" \
    FeatureFlag__NewUI="true"

# List all settings
az webapp config appsettings list \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  -o table

# Delete a setting
az webapp config appsettings delete \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --setting-names FeatureFlag__NewUI
```

**Accessing Settings in Code:**

```csharp
// .NET
var appName = Environment.GetEnvironmentVariable("ApplicationName");
var maxConnections = Configuration["MaxConnections"];
```

```javascript
// Node.js
const appName = process.env.ApplicationName;
const maxConnections = process.env.MaxConnections;
```

```python
# Python
import os
app_name = os.environ.get('ApplicationName')
max_connections = os.environ.get('MaxConnections')
```

### Connection Strings

```bash
# Add connection strings
az webapp config connection-string set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --connection-string-type SQLAzure \
  --settings \
    DefaultConnection="Server=tcp:myserver.database.windows.net,1433;Database=mydb;User ID=admin;Password=Pass@word1;" \
    CacheConnection="mycache.redis.cache.windows.net:6380,password=key,ssl=True"

# List connection strings (values masked)
az webapp config connection-string list \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  -o table
```

> **AZ-204 Exam Tip:** App Settings vs Connection Strings:
> - **App Settings**: General configuration, environment variables
> - **Connection Strings**: Database and cache connections, automatically parsed by frameworks
> - Both support slot-specific configuration
> - Both override values in appsettings.json or web.config
> - Connection strings have type: SQLAzure, SQLServer, MySQL, PostgreSQL, Custom, etc.

### General Configuration

```bash
# Configure runtime version
az webapp config set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --linux-fx-version "NODE|18-lts"

# Enable detailed error messages
az webapp config set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --http20-enabled true \
  --detailed-error-logging-enabled true

# Configure request tracing
az webapp config set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --request-tracing-enabled true

# Set default documents
az webapp config set \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --default-documents index.html index.htm default.html
```

## Exercise 7: Diagnostic Logging

**AZ-204 Critical Topic:** Enable and configure logging for monitoring and troubleshooting.

### Application Logging

```bash
# Enable application logging (File System)
az webapp log config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --application-logging filesystem \
  --level verbose

# Enable application logging (Blob Storage)
az webapp log config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --application-logging azureblobstorage \
  --level information \
  --azure-blob-storage-account-url "https://<storage-account>.blob.core.windows.net/<container>/<path>?<sas-token>" \
  --azure-blob-storage-retention 30
```

**Log Levels:**
- **Verbose**: Most detailed
- **Information**: General informational messages
- **Warning**: Warnings and errors
- **Error**: Errors only

### Web Server Logging

```bash
# Enable web server logging (File System)
az webapp log config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --web-server-logging filesystem

# Enable web server logging (Blob Storage)
az webapp log config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --web-server-logging storage \
  --azure-blob-storage-account-url "https://<storage-account>.blob.core.windows.net/<container>/<path>?<sas-token>" \
  --azure-blob-storage-retention 30
```

### Detailed Error Messages and Failed Request Tracing

```bash
# Enable detailed error messages
az webapp log config \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --detailed-error-messages true \
  --failed-request-tracing true
```

### Streaming Logs

```bash
# Stream application logs
az webapp log tail \
  -g labs-appservice-az204 \
  -n <webapp-name>

# Download logs
az webapp log download \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --log-file logs.zip
```

> **AZ-204 Exam Tip:** Logging types:
> - **Application Logging**: Your app's log output (Console.WriteLine, etc.)
>   - File System: 12 hours max, auto-disabled
>   - Blob Storage: Long-term retention
> - **Web Server Logging**: IIS logs (W3C format)
> - **Detailed Error Messages**: HTML error pages
> - **Failed Request Tracing**: Detailed IIS trace for failed requests
> - **Deployment Logging**: Git/ZIP deployment logs (always enabled)

## Exercise 8: WebJobs Basics

**AZ-204 Topic:** Background processing with WebJobs.

### WebJob Types

**Continuous WebJobs:**
- Run on all instances (by default)
- Can run on single instance with scale-out
- Good for continuous processing

**Triggered WebJobs:**
- Run on-demand or on schedule (CRON)
- Run on single instance
- Good for periodic tasks

### Create WebJob

```bash
# Package WebJob code
zip -r webjob.zip .

# Deploy continuous WebJob
az webapp deployment source config-zip \
  -g labs-appservice-az204 \
  -n <webapp-name> \
  --src webjob.zip

# Create scheduled WebJob (via Kudu API)
# Upload to: https://<webapp-name>.scm.azurewebsites.net/api/triggeredwebjobs/<webjob-name>
```

**WebJob File Structure:**
```
webjob.zip
â”œâ”€â”€ run.cmd or run.sh or run.exe
â””â”€â”€ settings.job (optional)
```

**settings.job for triggered WebJob:**
```json
{
  "schedule": "0 */5 * * * *",
  "is_singleton": true
}
```

CRON expression: `0 */5 * * * *` = Every 5 minutes

> **AZ-204 Exam Tip:** WebJobs vs Azure Functions:
> - **WebJobs**: Tightly coupled to App Service, continuous or triggered
> - **Azure Functions**: Serverless, more triggers, independent scaling
> - **When to use WebJobs**: Simple background tasks, already using App Service
> - **When to use Functions**: Event-driven, need multiple triggers, serverless scaling

### WebJob SDK Example

```csharp
using Microsoft.Azure.WebJobs;
using Microsoft.Extensions.Logging;

public class Functions
{
    // Triggered by queue message
    public static void ProcessQueueMessage(
        [QueueTrigger("myqueue")] string message,
        ILogger logger)
    {
        logger.LogInformation($"Processing message: {message}");
    }

    // Scheduled function (runs every hour)
    public static void ScheduledTask(
        [TimerTrigger("0 0 * * * *")] TimerInfo timer,
        ILogger logger)
    {
        logger.LogInformation("Running scheduled task");
    }
}
```

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **App Service Plan Tiers:**
   - Free/Shared: Development only
   - Basic: Basic production features
   - Standard: Full production features (slots, auto-scale)
   - Premium: Enhanced performance, VNet
   - Isolated: Maximum isolation and scale

2. **Deployment Slots:**
   - Available in Standard+ tier
   - Slot settings vs non-slot settings
   - Swap process and warm-up
   - Easy rollback (swap back)

3. **Scaling:**
   - **Scale up**: Change tier (more resources per instance)
   - **Scale out**: Add instances (horizontal scaling)
   - Manual vs auto-scale
   - Requires Standard+ tier for auto-scale

4. **Deployment Methods:**
   - Local Git, GitHub, Azure DevOps
   - ZIP deployment (via Azure CLI or Kudu API)
   - Container deployment (Docker)
   - FTP (legacy)

5. **Configuration:**
   - App Settings: Environment variables
   - Connection Strings: Typed configuration
   - Both support slot-specific settings
   - Both override local configuration files

6. **Logging:**
   - Application logs (your code)
   - Web server logs (IIS)
   - Storage options: File System (short-term), Blob (long-term)
   - Log levels: Verbose, Information, Warning, Error

### Common Exam Scenarios

1. **Scenario:** Deploy new version without downtime
   - **Solution:** Deploy to staging slot, test, swap to production

2. **Scenario:** Automatically scale during peak hours
   - **Solution:** Configure auto-scale with schedule-based rules

3. **Scenario:** Application running slow, needs more resources
   - **Solution:** Scale up (change to higher tier) for more CPU/memory per instance

4. **Scenario:** High traffic causing timeouts
   - **Solution:** Scale out (add instances) to distribute load

5. **Scenario:** Custom domain with HTTPS
   - **Solution:** Configure custom domain, create managed certificate or upload custom certificate

6. **Scenario:** Different database for staging and production
   - **Solution:** Use slot-specific connection strings

7. **Scenario:** Debug production issue
   - **Solution:** Enable application logging and stream logs with `az webapp log tail`

8. **Scenario:** Background job needs to run every hour
   - **Solution:** Create triggered WebJob with CRON schedule

## Best Practices

1. **Always use deployment slots** for production deployments
2. **Configure slot-specific settings** for environment-specific configuration
3. **Enable auto-scale** for variable workloads (requires Standard+ tier)
4. **Use managed certificates** for SSL (free and auto-renewed)
5. **Enable diagnostic logging** with Blob storage for long-term retention
6. **Monitor performance** with Application Insights
7. **Use managed identities** to access Azure resources securely
8. **Set minimum TLS version** to 1.2 for security
9. **Enable HTTPS only** for production apps
10. **Test deployments** in staging slot before swapping to production

## Cleanup

```bash
az group delete -y -n labs-appservice-az204 --no-wait
```

## Additional Resources

- [Azure App Service documentation](https://docs.microsoft.com/en-us/azure/app-service/)
- [App Service plans](https://docs.microsoft.com/en-us/azure/app-service/overview-hosting-plans)
- [Deployment slots](https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots)
- [Auto-scale in Azure](https://docs.microsoft.com/en-us/azure/azure-monitor/autoscale/autoscale-overview)
- [Configure SSL certificates](https://docs.microsoft.com/en-us/azure/app-service/configure-ssl-certificate)
- [WebJobs in App Service](https://docs.microsoft.com/en-us/azure/app-service/webjobs-create)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
