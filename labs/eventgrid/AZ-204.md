# Azure Event Grid - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Connect to and Consume Azure Services (20-25%)

This lab extends the basic Event Grid exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [Event Grid lab](README.md) first to understand fundamental Event Grid operations.

## AZ-204 Exam Skills Covered

- Implement solutions that use Azure Event Grid
- Create custom topics and event subscriptions
- Publish events to custom topics
- Configure event filtering and routing
- Implement retry policies and dead-letter handling
- Work with system topics (Blob Storage, Resource Groups)
- Event Grid vs Event Hubs vs Service Bus

## Exercise 1: Custom Topics and Event Publishing

**AZ-204 Critical Topic:** Custom topics allow applications to publish events.

### Create Custom Topic and Publish Events

```bash
az group create -n labs-eventgrid-az204 --tags courselabs=azure -l eastus

# Create Event Grid topic
az eventgrid topic create \
  -g labs-eventgrid-az204 \
  -n customer-events \
  -l eastus \
  --input-schema EventGridSchema
```

### Event Schema

Event Grid supports multiple schemas:
- **Event Grid Schema** (default, recommended)
- **Cloud Events v1.0** (CNCF standard)
- **Custom Input Schema** (your own format)

**Event Grid Schema format:**

```json
{
  "id": "unique-event-id",
  "eventType": "CustomerRegistered",
  "subject": "customers/cust-12345",
  "eventTime": "2024-01-15T10:30:00Z",
  "data": {
    "customerId": "12345",
    "email": "customer@example.com",
    "tier": "premium"
  },
  "dataVersion": "1.0"
}
```

> **AZ-204 Exam Tip:** Event Grid Schema fields:
> - **id**: Unique identifier (required)
> - **eventType**: Type of event (required)
> - **subject**: Event subject/resource path (required)
> - **eventTime**: Timestamp (required)
> - **data**: Event payload (optional)
> - **dataVersion**: Schema version (required)

### Publish Events Using .NET SDK

```csharp
using Azure;
using Azure.Messaging.EventGrid;

string topicEndpoint = "https://customer-events.eastus-1.eventgrid.azure.net/api/events";
string topicKey = "<topic-access-key>";

var client = new EventGridPublisherClient(
    new Uri(topicEndpoint),
    new AzureKeyCredential(topicKey));

// Create event
var @event = new EventGridEvent(
    subject: "customers/cust-12345",
    eventType: "CustomerRegistered",
    dataVersion: "1.0",
    data: new
    {
        CustomerId = "12345",
        Email = "customer@example.com",
        Tier = "premium",
        RegistrationDate = DateTime.UtcNow
    });

// Publish single event
await client.SendEventAsync(@event);

// Publish batch of events
var events = new List<EventGridEvent>
{
    new EventGridEvent("customers/cust-001", "CustomerRegistered", "1.0",
        new { CustomerId = "001", Email = "cust001@example.com" }),
    new EventGridEvent("customers/cust-002", "CustomerRegistered", "1.0",
        new { CustomerId = "002", Email = "cust002@example.com" }),
    new EventGridEvent("customers/cust-003", "CustomerRegistered", "1.0",
        new { CustomerId = "003", Email = "cust003@example.com" })
};

await client.SendEventsAsync(events);
```

ðŸ“‹ Publish events using the CLI with curl.

<details>
  <summary>Not sure how?</summary>

```bash
# Get topic details
TOPIC_ENDPOINT=$(az eventgrid topic show \
  -g labs-eventgrid-az204 \
  -n customer-events \
  --query endpoint -o tsv)

TOPIC_KEY=$(az eventgrid topic key list \
  -g labs-eventgrid-az204 \
  -n customer-events \
  --query key1 -o tsv)

# Create event JSON
cat > customer-event.json << 'EOF'
[
  {
    "id": "evt-001",
    "eventType": "CustomerRegistered",
    "subject": "customers/cust-12345",
    "eventTime": "2024-01-15T10:30:00Z",
    "data": {
      "customerId": "12345",
      "email": "customer@example.com",
      "tier": "premium"
    },
    "dataVersion": "1.0"
  }
]
EOF

# Publish event
curl -X POST "$TOPIC_ENDPOINT/api/events" \
  -H "aeg-sas-key: $TOPIC_KEY" \
  -H "Content-Type: application/json" \
  -d @customer-event.json
```

</details><br/>

## Exercise 2: Event Subscriptions and Filtering

**AZ-204 Critical Topic:** Subscriptions filter and route events to handlers.

### Event Handler Types

Event Grid supports multiple handler types:
- **Webhooks** (custom HTTP endpoints)
- **Azure Functions**
- **Logic Apps**
- **Event Hubs**
- **Service Bus Queues/Topics**
- **Storage Queues**
- **Hybrid Connections**

### Create Event Subscription with Filtering

```bash
# Get topic resource ID
TOPIC_ID=$(az eventgrid topic show \
  -g labs-eventgrid-az204 \
  -n customer-events \
  --query id -o tsv)

# Filter by event type
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name premium-customers-sub \
  --endpoint <webhook-url> \
  --included-event-types CustomerRegistered CustomerUpgraded \
  --advanced-filter data.tier StringIn premium enterprise
```

**Filter types:**

1. **Event Type Filter**: Include/exclude specific event types
2. **Subject Filter**: Begins with or ends with patterns
3. **Advanced Filters**: Filter on event data properties

### Advanced Filtering Examples

```bash
# Number comparison
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name high-value-orders \
  --endpoint <webhook-url> \
  --advanced-filter data.amount NumberGreaterThan 100

# String operations
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name us-customers \
  --endpoint <webhook-url> \
  --advanced-filter data.country StringIn US USA

# Boolean filter
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name verified-only \
  --endpoint <webhook-url> \
  --advanced-filter data.isVerified BoolEquals true

# Multiple filters (AND logic)
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name premium-us \
  --endpoint <webhook-url> \
  --advanced-filter data.tier StringIn premium \
  --advanced-filter data.country StringEquals US
```

> **AZ-204 Exam Tip:** Advanced filter operators:
> - **String**: StringIn, StringNotIn, StringBeginsWith, StringEndsWith, StringContains
> - **Number**: NumberIn, NumberNotIn, NumberLessThan, NumberGreaterThan, NumberLessThanOrEquals, NumberGreaterThanOrEquals
> - **Boolean**: BoolEquals
> - **Array**: NumberInRange, NumberNotInRange, StringInRange, StringNotInRange

### Subject Filtering

```bash
# Subject begins with pattern
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name europe-customers \
  --endpoint <webhook-url> \
  --subject-begins-with "customers/eu/"

# Subject ends with pattern
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name deleted-customers \
  --endpoint <webhook-url> \
  --subject-ends-with "/deleted"

# Combine begin and end patterns
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name specific-pattern \
  --endpoint <webhook-url> \
  --subject-begins-with "orders/" \
  --subject-ends-with "/completed"
```

## Exercise 3: Retry Policies and Dead-Letter

**AZ-204 Critical Topic:** Handle delivery failures with retry and dead-letter.

### Configure Retry Policy

```bash
# Create storage account for dead-letter
az storage account create \
  -g labs-eventgrid-az204 \
  -n <storage-account-name> \
  --sku Standard_LRS

# Create dead-letter container
az storage container create \
  -n deadletter \
  --account-name <storage-account-name>

# Get storage account resource ID
STORAGE_ID=$(az storage account show \
  -g labs-eventgrid-az204 \
  -n <storage-account-name> \
  --query id -o tsv)

# Create subscription with retry policy and dead-letter
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name resilient-sub \
  --endpoint <webhook-url> \
  --max-delivery-attempts 10 \
  --event-ttl 1440 \
  --deadletter-endpoint "$STORAGE_ID/blobServices/default/containers/deadletter"
```

**Retry Policy Parameters:**
- **max-delivery-attempts**: 1-30 attempts (default: 30)
- **event-ttl**: Time-to-live in minutes (default: 1440 = 24 hours)

**Retry Schedule:**
- Event Grid uses exponential backoff
- Initial retry: 10 seconds
- Subsequent retries: increasing intervals up to 24 hours

> **AZ-204 Exam Tip:** Dead-letter scenarios:
> - Max delivery attempts exceeded
> - Event TTL expired
> - 400 Bad Request (except 400 validation errors)
> - 413 Request Entity Too Large
> - Endpoint not found (404, 410)

### Test Dead-Letter Behavior

```bash
# Create subscription with invalid endpoint to force dead-letter
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name test-deadletter \
  --endpoint https://invalid-endpoint-12345.example.com/webhook \
  --max-delivery-attempts 3 \
  --event-ttl 5 \
  --deadletter-endpoint "$STORAGE_ID/blobServices/default/containers/deadletter"

# Publish event (will fail and be dead-lettered)
curl -X POST "$TOPIC_ENDPOINT/api/events" \
  -H "aeg-sas-key: $TOPIC_KEY" \
  -H "Content-Type: application/json" \
  -d '[{"id":"dead-letter-test","eventType":"Test","subject":"test","eventTime":"2024-01-15T10:00:00Z","data":{},"dataVersion":"1.0"}]'

# Wait a few minutes, then check dead-letter container
az storage blob list \
  -c deadletter \
  --account-name <storage-account-name> \
  -o table
```

## Exercise 4: System Topics

**AZ-204 Topic:** System topics capture events from Azure services.

### Blob Storage Events

```bash
# Get storage account resource ID
STORAGE_ID=$(az storage account show \
  -g labs-eventgrid-az204 \
  -n <storage-account-name> \
  --query id -o tsv)

# Subscribe to blob created events
az eventgrid event-subscription create \
  --source-resource-id $STORAGE_ID \
  --name blob-created \
  --endpoint <webhook-url> \
  --included-event-types Microsoft.Storage.BlobCreated

# Subscribe to blob deleted events
az eventgrid event-subscription create \
  --source-resource-id $STORAGE_ID \
  --name blob-deleted \
  --endpoint <webhook-url> \
  --included-event-types Microsoft.Storage.BlobDeleted
```

**Storage Event Types:**
- `Microsoft.Storage.BlobCreated`
- `Microsoft.Storage.BlobDeleted`
- `Microsoft.Storage.BlobRenamed`
- `Microsoft.Storage.DirectoryCreated`
- `Microsoft.Storage.DirectoryDeleted`

### Resource Group Events

```bash
# Subscribe to resource creation in subscription
az eventgrid event-subscription create \
  --name resource-created \
  --endpoint <webhook-url> \
  --included-event-types Microsoft.Resources.ResourceWriteSuccess \
  --advanced-filter data.operationName StringEquals Microsoft.Compute/virtualMachines/write
```

**Resource Event Types:**
- `Microsoft.Resources.ResourceWriteSuccess`
- `Microsoft.Resources.ResourceWriteFailure`
- `Microsoft.Resources.ResourceDeleteSuccess`
- `Microsoft.Resources.ResourceDeleteFailure`

ðŸ“‹ Create a subscription that triggers when a Function App is created in your subscription.

<details>
  <summary>Not sure how?</summary>

```bash
az eventgrid event-subscription create \
  --name function-app-created \
  --endpoint <webhook-url> \
  --included-event-types Microsoft.Resources.ResourceWriteSuccess \
  --advanced-filter data.operationName StringEquals Microsoft.Web/sites/write \
  --advanced-filter data.resourceProvider StringEquals Microsoft.Web
```

</details><br/>

## Exercise 5: Event Grid with Azure Functions

**AZ-204 Critical:** Function integration is a common exam scenario.

### Azure Function with Event Grid Trigger

```csharp
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.EventGrid;
using Azure.Messaging.EventGrid;
using Microsoft.Extensions.Logging;
using System.Text.Json;

public static class CustomerEventProcessor
{
    [FunctionName("ProcessCustomerEvent")]
    public static void Run(
        [EventGridTrigger] EventGridEvent eventGridEvent,
        ILogger log)
    {
        log.LogInformation($"Event Type: {eventGridEvent.EventType}");
        log.LogInformation($"Event Subject: {eventGridEvent.Subject}");

        // Parse event data
        var eventData = JsonSerializer.Deserialize<CustomerData>(
            eventGridEvent.Data.ToString());

        log.LogInformation($"Customer ID: {eventData.CustomerId}");
        log.LogInformation($"Email: {eventData.Email}");

        // Process based on event type
        switch (eventGridEvent.EventType)
        {
            case "CustomerRegistered":
                SendWelcomeEmail(eventData);
                break;
            case "CustomerUpgraded":
                SendUpgradeConfirmation(eventData);
                break;
        }
    }

    private static void SendWelcomeEmail(CustomerData customer)
    {
        // Implementation
    }

    private static void SendUpgradeConfirmation(CustomerData customer)
    {
        // Implementation
    }
}

public class CustomerData
{
    public string CustomerId { get; set; }
    public string Email { get; set; }
    public string Tier { get; set; }
}
```

### Create Event Subscription for Function

```bash
# Get Function resource ID
FUNCTION_ID=$(az functionapp function show \
  -g labs-eventgrid-az204 \
  -n <function-app-name> \
  --function-name ProcessCustomerEvent \
  --query id -o tsv)

# Create subscription pointing to Function
az eventgrid event-subscription create \
  --source-resource-id $TOPIC_ID \
  --name function-sub \
  --endpoint-type azurefunction \
  --endpoint $FUNCTION_ID
```

## Exercise 6: Event Grid vs Event Hubs vs Service Bus

**AZ-204 Exam Critical:** Understand when to use each service.

### Comparison Table

| Feature | Event Grid | Event Hubs | Service Bus |
|---------|------------|------------|-------------|
| **Pattern** | Pub/Sub (reactive) | Streaming | Messaging |
| **Use Case** | Event-driven apps | Big data streaming | Enterprise messaging |
| **Throughput** | Millions/sec | Millions/sec | Thousands/sec |
| **Message Size** | 1 MB | 1 MB | 256 KB (1 MB Premium) |
| **Ordering** | No guarantee | Per partition | FIFO with sessions |
| **Push/Pull** | Push | Pull | Push/Pull |
| **Retention** | 24 hours (retry) | 1-90 days | 14 days (max) |
| **Filtering** | Yes (advanced) | No | Yes (SQL filters) |
| **Protocol** | HTTP | AMQP, Kafka | AMQP |
| **Pricing** | Per operation | Per throughput unit | Per message |

### When to Use Each

**Event Grid:**
- React to Azure service events (blob created, VM started)
- Loosely coupled event-driven architecture
- Fan-out to multiple handlers
- Simple event routing with filtering

**Event Hubs:**
- Big data streaming
- Telemetry and log ingestion
- Real-time analytics
- High-throughput event ingestion

**Service Bus:**
- Enterprise messaging
- Guaranteed message delivery
- FIFO ordering required
- Transactional processing
- Complex routing and filtering

> **AZ-204 Exam Tip:** Choose Event Grid when:
> - You need to react to state changes
> - Multiple subscribers need the same event
> - Events come from Azure services
> - You need advanced filtering

## Exercise 7: Webhook Validation

**AZ-204 Topic:** Webhooks must respond to validation requests.

### Validation Handshake

When creating a subscription with a webhook, Event Grid sends a validation event:

```json
{
  "id": "unique-id",
  "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
  "subject": "",
  "data": {
    "validationCode": "12345678-1234-1234-1234-123456789012",
    "validationUrl": "https://..."
  },
  "eventTime": "2024-01-15T10:00:00Z",
  "dataVersion": "1.0"
}
```

**Your webhook must respond with:**

Option 1 - Synchronous validation (respond in < 30 seconds):
```json
{
  "validationResponse": "12345678-1234-1234-1234-123456789012"
}
```

Option 2 - Asynchronous validation (make GET request to validationUrl)

### Example Webhook Handler (C#)

```csharp
[HttpPost]
public IActionResult Webhook([FromBody] EventGridEvent[] events)
{
    foreach (var eventGridEvent in events)
    {
        // Handle validation
        if (eventGridEvent.EventType == "Microsoft.EventGrid.SubscriptionValidationEvent")
        {
            var data = (JObject)eventGridEvent.Data;
            var validationCode = data["validationCode"].ToString();

            return Ok(new { validationResponse = validationCode });
        }

        // Handle actual events
        ProcessEvent(eventGridEvent);
    }

    return Ok();
}
```

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **Event Grid Components:**
   - **Topics**: Event sources (custom or system)
   - **Subscriptions**: Route events to handlers
   - **Event handlers**: Process events
   - **Filters**: Control which events are delivered

2. **Event Schema:**
   - Required fields: id, eventType, subject, eventTime, dataVersion
   - Optional fields: data, topic
   - Support for CloudEvents schema

3. **Filtering:**
   - Event type filtering
   - Subject filtering (begins/ends with)
   - Advanced filtering (data properties)
   - Multiple filters with AND logic

4. **Delivery:**
   - Push model (not pull)
   - At-least-once delivery
   - Retry with exponential backoff
   - Dead-letter for failed deliveries

5. **System Topics:**
   - Blob Storage events
   - Resource Group/Subscription events
   - Key Vault events
   - IoT Hub events

### Common Exam Scenarios

1. **Scenario:** Process files when uploaded to blob storage
   - **Solution:** Create Event Grid subscription for BlobCreated event, route to Function

2. **Scenario:** Send only high-value orders to premium processor
   - **Solution:** Use advanced filter: `data.amount NumberGreaterThan 1000`

3. **Scenario:** Handle failed event deliveries
   - **Solution:** Configure dead-letter endpoint to blob storage

4. **Scenario:** React to resource deletions across subscription
   - **Solution:** System topic with ResourceDeleteSuccess event type

5. **Scenario:** Multiple systems need same events with different filters
   - **Solution:** Multiple subscriptions on same topic with different filters

## Best Practices

1. **Use system topics** for Azure service events (don't poll for changes)
2. **Implement idempotency** in handlers (at-least-once delivery)
3. **Use dead-letter** for production scenarios
4. **Filter at subscription** level to reduce handler invocations
5. **Validate webhooks** properly to avoid subscription failures
6. **Use managed identities** for authentication when possible
7. **Monitor delivery** failures and dead-letter queue
8. **Batch events** when publishing for better throughput

## Cleanup

```bash
az group delete -y -n labs-eventgrid-az204 --no-wait
```

## Additional Resources

- [Azure Event Grid documentation](https://docs.microsoft.com/en-us/azure/event-grid/)
- [Event Grid SDK for .NET](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/messaging.eventgrid-readme)
- [Event Grid event schema](https://docs.microsoft.com/en-us/azure/event-grid/event-schema)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
