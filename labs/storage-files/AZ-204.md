# Azure Files - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Develop for Azure Storage (15-20%)

This lab extends the basic Azure Files exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [Azure Files lab](README.md) first to understand fundamental file share operations.

## AZ-204 Exam Skills Covered

- Azure Files vs Blob Storage comparison and use cases
- SMB and NFS protocol support
- Mounting file shares to Windows and Linux
- File share integration with applications
- File share snapshots and backup
- Access tiers for Azure Files (Transaction optimized, Hot, Cool)
- Azure File Sync for hybrid scenarios
- Identity-based authentication (Azure AD)

## Exercise 1: Azure Files vs Blob Storage

**AZ-204 Critical Topic:** Understanding when to use each service.

### Comparison Table

| Feature | Azure Files | Blob Storage |
|---------|-------------|--------------|
| **Protocol** | SMB 3.0, NFS 4.1, REST | REST, Data Lake (ADLS Gen2) |
| **Access method** | Mount as drive, REST API | REST API, SDK |
| **Use case** | File shares, lift-and-shift | Object storage, big data, static websites |
| **Directory structure** | Yes (hierarchical) | Flat (simulated with prefixes) |
| **File locking** | Yes | No (lease for blob-level) |
| **On-premises integration** | Azure File Sync | N/A |
| **Maximum file size** | 4 TiB | 190.7 TiB (block blob) |
| **Performance** | Standard (HDD), Premium (SSD) | Standard (HDD), Premium (SSD) |
| **Snapshots** | Share-level snapshots | Blob-level snapshots |
| **Access tiers** | Transaction optimized, Hot, Cool | Hot, Cool, Archive |

> **AZ-204 Exam Tip:** Use Azure Files when:
> - Need SMB/NFS file share protocol
> - Lift-and-shift legacy applications
> - Shared access from multiple VMs/applications
> - On-premises integration with Azure File Sync
> - Need file locking semantics
>
> Use Blob Storage when:
> - Object storage for unstructured data
> - Serving content to web/mobile apps
> - Streaming video/audio
> - Big data analytics
> - Backup and disaster recovery
> - Archive tier for cold data

## Exercise 2: Create and Configure File Shares

### Standard File Share

```bash
# Create resource group
az group create -n labs-files-az204 --tags courselabs=azure -l eastus

# Create storage account for files
az storage account create \
  -g labs-files-az204 \
  -n <storage-name> \
  --sku Standard_LRS \
  --kind StorageV2

# Get connection string
CONNECTION_STRING=$(az storage account show-connection-string \
  -g labs-files-az204 \
  -n <storage-name> \
  --query connectionString -o tsv)

# Create file share
az storage share create \
  --name appshare \
  --connection-string "$CONNECTION_STRING" \
  --quota 100
```

### Premium File Share

```bash
# Create premium storage account (FileStorage kind)
az storage account create \
  -g labs-files-az204 \
  -n <premium-storage-name> \
  --sku Premium_LRS \
  --kind FileStorage

# Get connection string
PREMIUM_CONNECTION_STRING=$(az storage account show-connection-string \
  -g labs-files-az204 \
  -n <premium-storage-name> \
  --query connectionString -o tsv)

# Create premium file share (minimum 100 GiB)
az storage share create \
  --name premiumshare \
  --connection-string "$PREMIUM_CONNECTION_STRING" \
  --quota 100
```

ðŸ“‹ List all file shares in the storage account.

<details>
  <summary>Not sure how?</summary>

```bash
az storage share list \
  --connection-string "$CONNECTION_STRING" \
  -o table
```

</details><br/>

> **AZ-204 Exam Tip:** File share tiers:
> - **Standard (Transaction optimized)**: General purpose, balanced cost
> - **Standard (Hot)**: Team shares, Azure File Sync
> - **Standard (Cool)**: Archive and backup scenarios, lower storage cost, higher transaction cost
> - **Premium**: High performance, low latency, provisioned IOPS and throughput

## Exercise 3: SMB and NFS Protocol Support

**AZ-204 Topic:** Understanding protocol capabilities.

### SMB File Shares

```bash
# Create SMB file share (default)
az storage share create \
  --name smbshare \
  --connection-string "$CONNECTION_STRING" \
  --quota 50
```

> **AZ-204 Exam Tip:** SMB (Server Message Block) features:
> - **SMB 3.0+**: Encryption, multichannel, transparent failover
> - **Supported versions**: SMB 3.0, 3.1.1
> - **Platforms**: Windows, Linux (with cifs-utils), macOS
> - **Authentication**: Storage account key, Azure AD (domain-joined)
> - **Protocols**: Port 445 (TCP)
> - **Features**: File locking, directory/file attributes

### NFS File Shares (Premium only)

```bash
# Create storage account with NFS support
az storage account create \
  -g labs-files-az204 \
  -n <nfs-storage-name> \
  --sku Premium_LRS \
  --kind FileStorage \
  --enable-large-file-share

# Create NFS 4.1 file share
az storage share-rm create \
  -g labs-files-az204 \
  --storage-account <nfs-storage-name> \
  --name nfsshare \
  --quota 100 \
  --enabled-protocol NFS
```

> **AZ-204 Exam Tip:** NFS (Network File System) features:
> - **Version**: NFS 4.1 only
> - **Storage**: Premium only (FileStorage accounts)
> - **Authentication**: Network-based (no identity authentication)
> - **Performance**: High performance, low latency
> - **Platforms**: Linux, Windows (with NFS client)
> - **Use cases**: Linux applications, containerized workloads
> - **No encryption at rest** - use network-level security

## Exercise 4: Mounting File Shares

**AZ-204 Practical Topic:** Mounting file shares to Windows and Linux.

### Mount on Windows

Get connection script:

```bash
# Get Windows mount command
az storage share show \
  --name appshare \
  --connection-string "$CONNECTION_STRING" \
  --query "properties"
```

PowerShell mount script:

```powershell
# Get storage account key
$storageAccountKey = "<storage-account-key>"
$storageAccountName = "<storage-name>"

# Create credential
$connectTestResult = Test-NetConnection -ComputerName "$storageAccountName.file.core.windows.net" -Port 445
if ($connectTestResult.TcpTestSucceeded) {
    # Mount the drive
    cmd.exe /C "cmdkey /add:`"$storageAccountName.file.core.windows.net`" /user:`"Azure\$storageAccountName`" /pass:`"$storageAccountKey`""

    New-PSDrive -Name Z -PSProvider FileSystem -Root "\\$storageAccountName.file.core.windows.net\appshare" -Persist
}
else {
    Write-Error -Message "Unable to reach the Azure storage account via port 445."
}
```

### Mount on Linux

```bash
# Install cifs-utils
sudo apt-get update
sudo apt-get install cifs-utils

# Create mount point
sudo mkdir -p /mnt/appshare

# Get storage account key
STORAGE_KEY=$(az storage account keys list \
  -g labs-files-az204 \
  -n <storage-name> \
  --query '[0].value' -o tsv)

# Mount the share
sudo mount -t cifs \
  //<storage-name>.file.core.windows.net/appshare \
  /mnt/appshare \
  -o vers=3.0,username=<storage-name>,password=$STORAGE_KEY,dir_mode=0777,file_mode=0777,serverino
```

Persistent mount (add to /etc/fstab):

```bash
# Create credentials file
sudo bash -c 'cat > /etc/smbcredentials/storage.cred << EOF
username=<storage-name>
password=<storage-key>
EOF'

# Secure credentials file
sudo chmod 600 /etc/smbcredentials/storage.cred

# Add to /etc/fstab
sudo bash -c 'echo "//<storage-name>.file.core.windows.net/appshare /mnt/appshare cifs nofail,vers=3.0,credentials=/etc/smbcredentials/storage.cred,dir_mode=0777,file_mode=0777,serverino" >> /etc/fstab'

# Mount all
sudo mount -a
```

ðŸ“‹ Mount an NFS share on Linux.

<details>
  <summary>Not sure how?</summary>

```bash
# Install NFS client
sudo apt-get install nfs-common

# Create mount point
sudo mkdir -p /mnt/nfsshare

# Mount NFS share
sudo mount -t nfs \
  -o vers=4.1,sec=sys \
  <nfs-storage-name>.file.core.windows.net:/<nfs-storage-name>/nfsshare \
  /mnt/nfsshare
```

</details><br/>

> **AZ-204 Exam Tip:** Mounting requirements:
> - **Port 445** must be open (often blocked by ISPs)
> - **Storage account key** or **SAS token** for SMB authentication
> - **Network connectivity** to *.file.core.windows.net
> - **cifs-utils** (Linux SMB) or **nfs-common** (Linux NFS)
> - Use **private endpoint** to avoid port 445 blocks

## Exercise 5: File Operations with SDK

**AZ-204 Critical Topic:** Programmatic file operations.

### .NET SDK Example

```csharp
using Azure.Storage.Files.Shares;
using Azure.Storage.Files.Shares.Models;

// Connect to file share
var shareClient = new ShareClient(connectionString, "appshare");

// Create share if not exists
await shareClient.CreateIfNotExistsAsync();

// Get directory client
var directoryClient = shareClient.GetDirectoryClient("documents");
await directoryClient.CreateIfNotExistsAsync();

// Upload file
var fileClient = directoryClient.GetFileClient("report.pdf");
using (FileStream stream = File.OpenRead("local-report.pdf"))
{
    await fileClient.CreateAsync(stream.Length);
    await fileClient.UploadAsync(stream);
}

// Set file metadata
var metadata = new Dictionary<string, string>
{
    { "department", "finance" },
    { "year", "2024" }
};
await fileClient.SetMetadataAsync(metadata);

// Download file
var download = await fileClient.DownloadAsync();
using (FileStream stream = File.OpenWrite("downloaded-report.pdf"))
{
    await download.Value.Content.CopyToAsync(stream);
}

// List files in directory
await foreach (ShareFileItem item in directoryClient.GetFilesAndDirectoriesAsync())
{
    Console.WriteLine($"{item.Name} - {item.IsDirectory}");
}

// Delete file
await fileClient.DeleteIfExistsAsync();
```

### Python SDK Example

```python
from azure.storage.fileshare import ShareServiceClient, ShareClient, ShareFileClient

# Connect to file share
service_client = ShareServiceClient.from_connection_string(connection_string)
share_client = service_client.get_share_client("appshare")

# Create directory
directory_client = share_client.get_directory_client("documents")
directory_client.create_directory()

# Upload file
file_client = share_client.get_file_client("documents/report.pdf")
with open("local-report.pdf", "rb") as data:
    file_client.upload_file(data)

# Set metadata
metadata = {"department": "finance", "year": "2024"}
file_client.set_file_metadata(metadata)

# Download file
with open("downloaded-report.pdf", "wb") as file:
    data = file_client.download_file()
    file.write(data.readall())

# List files
items = list(directory_client.list_directories_and_files())
for item in items:
    print(f"{item['name']} - {item.get('is_directory', False)}")
```

### REST API Operations

```bash
# Upload file using REST API
STORAGE_ACCOUNT="<storage-name>"
SHARE_NAME="appshare"
FILE_PATH="documents/test.txt"
STORAGE_KEY="<storage-key>"

# Create file
curl -X PUT \
  -H "x-ms-date: $(date -u '+%a, %d %b %Y %H:%M:%S GMT')" \
  -H "x-ms-version: 2021-04-10" \
  -H "x-ms-type: file" \
  -H "x-ms-content-length: 1024" \
  -H "Authorization: SharedKey $STORAGE_ACCOUNT:$STORAGE_KEY" \
  "https://$STORAGE_ACCOUNT.file.core.windows.net/$SHARE_NAME/$FILE_PATH"
```

## Exercise 6: File Share Snapshots

**AZ-204 Topic:** Point-in-time backup and recovery.

### Create Snapshots

```bash
# Create snapshot
az storage share snapshot \
  --name appshare \
  --connection-string "$CONNECTION_STRING"

# List snapshots
az storage share list \
  --connection-string "$CONNECTION_STRING" \
  --include-snapshots \
  --query "[?name=='appshare'].{Name:name, Snapshot:snapshot}" \
  -o table
```

### Browse Snapshot Content

```bash
# Get snapshot time
SNAPSHOT=$(az storage share list \
  --connection-string "$CONNECTION_STRING" \
  --include-snapshots \
  --query "[?name=='appshare' && snapshot!=null].snapshot" \
  -o tsv | head -n 1)

# List files in snapshot
az storage file list \
  --share-name appshare \
  --connection-string "$CONNECTION_STRING" \
  --snapshot "$SNAPSHOT" \
  -o table
```

### Restore from Snapshot

```bash
# Restore specific file from snapshot
az storage file download \
  --share-name appshare \
  --connection-string "$CONNECTION_STRING" \
  --path "documents/important.txt" \
  --snapshot "$SNAPSHOT" \
  --dest "./restored-important.txt"

# Re-upload to restore
az storage file upload \
  --share-name appshare \
  --connection-string "$CONNECTION_STRING" \
  --source "./restored-important.txt" \
  --path "documents/important.txt"
```

ðŸ“‹ Delete a snapshot.

<details>
  <summary>Not sure how?</summary>

```bash
az storage share delete \
  --name appshare \
  --connection-string "$CONNECTION_STRING" \
  --snapshot "$SNAPSHOT"
```

</details><br/>

> **AZ-204 Exam Tip:** Snapshot features:
> - **Share-level**: Snapshot entire file share
> - **Read-only**: Snapshots are immutable
> - **Incremental**: Only changed blocks stored
> - **Maximum 200 snapshots** per share
> - **Retention**: Manual deletion required (no auto-expiry)
> - **Billing**: Only for differential data
> - **Restore**: Download and re-upload files, or restore entire share

### SDK Snapshot Example

```csharp
using Azure.Storage.Files.Shares;
using Azure.Storage.Files.Shares.Models;

var shareClient = new ShareClient(connectionString, "appshare");

// Create snapshot
ShareSnapshotInfo snapshot = await shareClient.CreateSnapshotAsync();
Console.WriteLine($"Snapshot created: {snapshot.Snapshot}");

// Create client for snapshot
var snapshotClient = shareClient.WithSnapshot(snapshot.Snapshot);

// List files in snapshot
await foreach (ShareFileItem item in snapshotClient.GetRootDirectoryClient().GetFilesAndDirectoriesAsync())
{
    Console.WriteLine($"Snapshot file: {item.Name}");
}

// Delete snapshot
await snapshotClient.DeleteAsync();
```

## Exercise 7: Access Tiers for Azure Files

**AZ-204 Cost Optimization:** Understanding access tiers.

### Standard File Share Tiers

```bash
# Create transaction-optimized share (default)
az storage share create \
  --name txshare \
  --connection-string "$CONNECTION_STRING" \
  --quota 100

# Create hot tier share
az storage share-rm create \
  -g labs-files-az204 \
  --storage-account <storage-name> \
  --name hotshare \
  --quota 100 \
  --access-tier Hot

# Create cool tier share
az storage share-rm create \
  -g labs-files-az204 \
  --storage-account <storage-name> \
  --name coolshare \
  --quota 100 \
  --access-tier Cool
```

### Change Access Tier

```bash
# Update share to cool tier
az storage share-rm update \
  -g labs-files-az204 \
  --storage-account <storage-name> \
  --name hotshare \
  --access-tier Cool
```

> **AZ-204 Exam Tip:** Access tier comparison:
> - **Transaction optimized (default)**:
>   - Lowest per-transaction cost
>   - Higher storage cost than cool
>   - Best for: Active workloads with many transactions
>
> - **Hot**:
>   - Optimized for general purpose file shares
>   - Lower storage cost than transaction optimized
>   - Higher transaction cost
>   - Best for: Team shares, Azure File Sync
>
> - **Cool**:
>   - Lowest storage cost
>   - Highest transaction cost
>   - 30-day minimum storage duration
>   - Best for: Archive, backup, disaster recovery
>
> - **Premium**:
>   - Provisioned IOPS and throughput
>   - SSD-based storage
>   - Lowest latency
>   - Best for: Performance-sensitive workloads

## Exercise 8: Azure File Sync

**AZ-204 Hybrid Topic:** Syncing on-premises file servers with Azure.

### Deploy Azure File Sync

```bash
# Create Storage Sync Service
az resource create \
  --resource-group labs-files-az204 \
  --name filesyncsvc \
  --resource-type "Microsoft.StorageSync/storageSyncServices" \
  --location eastus

# Create sync group
az resource create \
  --resource-group labs-files-az204 \
  --name syncgroup1 \
  --parent filesyncsvc \
  --resource-type "Microsoft.StorageSync/storageSyncServices/syncGroups" \
  --properties "{}"

# Register cloud endpoint (Azure file share)
SHARE_ID=$(az storage share-rm show \
  -g labs-files-az204 \
  --storage-account <storage-name> \
  --name appshare \
  --query id -o tsv)

az resource create \
  --resource-group labs-files-az204 \
  --name cloudendpoint1 \
  --parent filesyncsvc/syncGroups/syncgroup1 \
  --resource-type "Microsoft.StorageSync/storageSyncServices/syncGroups/cloudEndpoints" \
  --properties "{\"storageAccountResourceId\":\"$SHARE_ID\"}"
```

> **AZ-204 Exam Tip:** Azure File Sync components:
> - **Storage Sync Service**: Management resource in Azure
> - **Sync Group**: Defines sync topology
> - **Cloud Endpoint**: Azure file share (one per sync group)
> - **Server Endpoint**: Path on registered Windows Server
> - **Registered Server**: Windows Server with sync agent installed
>
> Features:
> - **Multi-site access**: Multiple servers sync with same cloud endpoint
> - **Cloud tiering**: Cache frequently accessed files, tier cold files to cloud
> - **Rapid disaster recovery**: Restore from any server or cloud
> - **Namespace**: Single namespace spanning on-premises and cloud

### Cloud Tiering

```bash
# Enable cloud tiering (via portal or ARM template)
# Properties:
# - volumeFreeSpacePercent: Minimum free space on local volume (e.g., 20%)
# - daysToKeep: Days to keep files locally before tiering
```

> **AZ-204 Exam Tip:** Cloud tiering benefits:
> - Reduces on-premises storage requirements
> - Automatically tiers cold files to Azure
> - Fast access to hot files (local cache)
> - Recalled on-demand when accessed
> - Preserves file system semantics

## Exercise 9: Identity-Based Authentication

**AZ-204 Security Topic:** Azure AD authentication for file shares.

### Enable Azure AD Authentication

```bash
# Join storage account to Azure AD Domain Services
# (Requires Azure AD DS or on-premises AD sync)

# Assign RBAC role to user
STORAGE_ID=$(az storage account show \
  -g labs-files-az204 \
  -n <storage-name> \
  --query id -o tsv)

az role assignment create \
  --role "Storage File Data SMB Share Contributor" \
  --assignee user@contoso.com \
  --scope "$STORAGE_ID/fileServices/default/fileshares/appshare"
```

> **AZ-204 Exam Tip:** Azure AD authentication:
> - **Requirements**: Domain-joined VMs (Azure AD DS or AD DS)
> - **RBAC roles**:
>   - **Storage File Data SMB Share Reader**: Read access
>   - **Storage File Data SMB Share Contributor**: Read, write, delete
>   - **Storage File Data SMB Share Elevated Contributor**: Read, write, delete, modify ACLs
> - **Benefits**: No storage account key needed, identity-based access
> - **Protocols**: SMB only (not REST API or NFS)

### Mount with Azure AD

```powershell
# Windows - mount with Azure AD credentials
$connectTestResult = Test-NetConnection -ComputerName "<storage-name>.file.core.windows.net" -Port 445

if ($connectTestResult.TcpTestSucceeded) {
    # No cmdkey needed - uses Azure AD credentials
    net use Z: \\<storage-name>.file.core.windows.net\appshare
}
```

## Exercise 10: File Share Metrics and Monitoring

```bash
# Enable diagnostic settings
STORAGE_ID=$(az storage account show \
  -g labs-files-az204 \
  -n <storage-name> \
  --query id -o tsv)

az monitor diagnostic-settings create \
  --name file-diagnostics \
  --resource "$STORAGE_ID/fileServices/default" \
  --logs '[{"category":"StorageRead","enabled":true},{"category":"StorageWrite","enabled":true},{"category":"StorageDelete","enabled":true}]' \
  --metrics '[{"category":"Transaction","enabled":true}]' \
  --workspace <log-analytics-workspace-id>
```

> **AZ-204 Exam Tip:** Monitoring metrics:
> - **Capacity**: Used capacity per share
> - **Transactions**: Read, write, delete operations
> - **Availability**: Success rate
> - **Latency**: End-to-end latency, server latency
> - **IOPS**: Operations per second
> - **Throughput**: Bytes per second

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **Azure Files Basics:**
   - SMB 3.0/3.1.1 and NFS 4.1 protocol support
   - Fully managed file shares in the cloud
   - Mount as network drive on Windows, Linux, macOS
   - Access via REST API and SDK

2. **Storage Tiers:**
   - **Standard**: Transaction optimized, Hot, Cool
   - **Premium**: SSD-based, provisioned performance

3. **Protocols:**
   - **SMB**: Windows and Linux, port 445, authentication with keys or Azure AD
   - **NFS**: Linux workloads, network-based auth, premium only

4. **Mounting:**
   - Windows: net use, New-PSDrive
   - Linux: mount.cifs (SMB), mount.nfs (NFS)
   - Requires port 445 or private endpoint

5. **Snapshots:**
   - Share-level, read-only, incremental
   - Maximum 200 per share
   - Manual deletion required

6. **Azure File Sync:**
   - Hybrid file server solution
   - Cloud tiering for storage optimization
   - Multi-site sync capability

7. **Authentication:**
   - Storage account key
   - SAS token
   - Azure AD (domain-joined, SMB only)

8. **SDK Operations:**
   - ShareClient, ShareDirectoryClient, ShareFileClient
   - Upload, download, list, delete
   - Metadata and properties

### Common Exam Scenarios

1. **Scenario:** Migrate on-premises file server to Azure
   - **Solution:** Azure Files with Azure File Sync, enable cloud tiering

2. **Scenario:** Share configuration files across multiple VMs
   - **Solution:** Azure Files SMB share, mount on all VMs

3. **Scenario:** Linux application needs shared storage
   - **Solution**: Premium Azure Files with NFS 4.1

4. **Scenario:** Port 445 blocked by ISP
   - **Solution**: Use private endpoint with VPN or ExpressRoute

5. **Scenario:** Point-in-time recovery for file share
   - **Solution**: Enable snapshots, restore from snapshot

6. **Scenario:** Optimize costs for backup file share
   - **Solution**: Use Cool access tier, minimize transactions

7. **Scenario:** Secure access without storage keys
   - **Solution**: Azure AD authentication with RBAC roles (domain-joined)

8. **Scenario:** High-performance file share for database workload
   - **Solution**: Premium file share with provisioned IOPS

## Best Practices

1. **Use Premium files** for performance-sensitive workloads
2. **Enable snapshots** for backup and recovery
3. **Choose appropriate access tier** to optimize costs
4. **Use private endpoints** when port 445 is blocked
5. **Implement Azure File Sync** for hybrid scenarios
6. **Enable Azure AD authentication** for better security
7. **Monitor metrics** for performance and capacity planning
8. **Use managed identity** in applications when possible
9. **Configure firewall rules** to restrict access
10. **Regular snapshot schedule** for data protection

## Cleanup

```bash
az group delete -y -n labs-files-az204 --no-wait
```

## Additional Resources

- [Azure Files documentation](https://docs.microsoft.com/en-us/azure/storage/files/)
- [Azure Files SDK for .NET](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/storage.files.shares-readme)
- [Azure File Sync documentation](https://docs.microsoft.com/en-us/azure/storage/file-sync/)
- [Mounting Azure Files](https://docs.microsoft.com/en-us/azure/storage/files/storage-how-to-use-files-windows)
- [AZ-204 Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
