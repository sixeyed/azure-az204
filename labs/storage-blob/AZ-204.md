# Blob Storage - AZ-204 Exam Exercises

**AZ-204 Exam Domain:** Develop for Azure Storage (15-20%)

This lab extends the basic blob storage exercises with specific scenarios and skills required for the AZ-204 exam.

## Prerequisites

Complete the basic [Blob Storage lab](README.md) first to understand fundamental blob storage operations.

## AZ-204 Exam Skills Covered

- Set and retrieve properties and metadata
- Perform operations on data using the appropriate SDK
- Implement storage policies and data lifecycle management
- Implement static website hosting

## Exercise 1: Working with Blob Metadata and Properties

Blob metadata allows you to store custom key-value pairs with your blobs - this is critical for AZ-204.

### Set and Retrieve Blob Metadata

Create a test blob with metadata:

```bash
# Upload a blob with metadata
az storage blob upload \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt \
  --file README.md \
  --metadata department=engineering owner=alice project=az204
```

ðŸ“‹ Retrieve the blob metadata using the CLI and verify the custom metadata is present.

<details>
  <summary>Not sure how?</summary>

```bash
az storage blob metadata show \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt
```

</details><br/>

Update the metadata:

```bash
az storage blob metadata update \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt \
  --metadata department=sales owner=bob status=approved
```

> **AZ-204 Exam Tip:** Metadata is often used for tagging, categorization, and custom application logic without modifying the blob content itself.

### Work with Blob Properties

List all properties of a blob:

```bash
az storage blob show \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt \
  --query '{contentType:properties.contentType, contentLength:properties.contentLength, blobType:properties.blobType, accessTier:properties.accessTier, lastModified:properties.lastModified, etag:properties.etag}'
```

ðŸ“‹ Change the content type of the blob to `text/markdown`.

<details>
  <summary>Not sure how?</summary>

```bash
az storage blob update \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt \
  --content-type text/markdown
```

</details><br/>

## Exercise 2: Blob Lifecycle Management Policies

**AZ-204 Critical Topic:** Lifecycle management automates blob tier transitions and deletion based on rules.

### Create a Lifecycle Management Policy

Create a JSON policy file for lifecycle management:

```bash
cat > lifecycle-policy.json << 'EOF'
{
  "rules": [
    {
      "enabled": true,
      "name": "move-to-cool-after-30-days",
      "type": "Lifecycle",
      "definition": {
        "actions": {
          "baseBlob": {
            "tierToCool": {
              "daysAfterModificationGreaterThan": 30
            },
            "tierToArchive": {
              "daysAfterModificationGreaterThan": 90
            },
            "delete": {
              "daysAfterModificationGreaterThan": 365
            }
          }
        },
        "filters": {
          "blobTypes": [
            "blockBlob"
          ]
        }
      }
    }
  ]
}
EOF
```

Apply the lifecycle management policy:

```bash
az storage account management-policy create \
  --account-name <sa-name> \
  --policy @lifecycle-policy.json
```

Verify the policy:

```bash
az storage account management-policy show \
  --account-name <sa-name>
```

ðŸ“‹ Create an additional policy rule that moves blobs with prefix `logs/` to cool storage after 7 days and archives after 30 days.

<details>
  <summary>Not sure how?</summary>

```bash
cat > lifecycle-policy-logs.json << 'EOF'
{
  "rules": [
    {
      "enabled": true,
      "name": "logs-archival",
      "type": "Lifecycle",
      "definition": {
        "actions": {
          "baseBlob": {
            "tierToCool": {
              "daysAfterModificationGreaterThan": 7
            },
            "tierToArchive": {
              "daysAfterModificationGreaterThan": 30
            },
            "delete": {
              "daysAfterModificationGreaterThan": 180
            }
          }
        },
        "filters": {
          "blobTypes": ["blockBlob"],
          "prefixMatch": ["logs/"]
        }
      }
    }
  ]
}
EOF

az storage account management-policy create \
  --account-name <sa-name> \
  --policy @lifecycle-policy-logs.json
```

</details><br/>

> **AZ-204 Exam Tip:** Understand the differences between Hot, Cool, and Archive tiers:
> - **Hot**: Optimized for frequently accessed data, highest storage cost, lowest access cost
> - **Cool**: Infrequently accessed data (30+ days), lower storage cost, higher access cost, minimum 30-day storage
> - **Archive**: Rarely accessed data (180+ days), lowest storage cost, highest access/rehydration cost, hours to retrieve

## Exercise 3: Advanced SAS Token Management

### Create Container-Level SAS with Specific Permissions

```bash
# Get storage account key
STORAGE_KEY=$(az storage account keys list \
  --account-name <sa-name> \
  --query '[0].value' -o tsv)

# Create container-level SAS token with read and list permissions
az storage container generate-sas \
  --account-name <sa-name> \
  --account-key $STORAGE_KEY \
  --name labs \
  --permissions rl \
  --expiry $(date -u -d "2 hours" '+%Y-%m-%dT%H:%MZ') \
  --https-only
```

ðŸ“‹ Create a SAS token that allows write, delete, and list permissions but NOT read, valid for 24 hours.

<details>
  <summary>Not sure how?</summary>

```bash
az storage container generate-sas \
  --account-name <sa-name> \
  --account-key $STORAGE_KEY \
  --name labs \
  --permissions wdl \
  --expiry $(date -u -d "24 hours" '+%Y-%m-%dT%H:%MZ') \
  --https-only
```

Permission codes:
- **r**: Read
- **w**: Write
- **d**: Delete
- **l**: List
- **a**: Add
- **c**: Create

</details><br/>

### IP-Based SAS Token Restrictions

```bash
# Create SAS token restricted to specific IP address
az storage container generate-sas \
  --account-name <sa-name> \
  --account-key $STORAGE_KEY \
  --name labs \
  --permissions r \
  --expiry $(date -u -d "1 hour" '+%Y-%m-%dT%H:%MZ') \
  --ip "203.0.113.0-203.0.113.255" \
  --https-only
```

> **AZ-204 Exam Tip:** SAS tokens can be restricted by IP address/range, start/expiry time, protocol (HTTPS only), and can be associated with stored access policies for revocation capability.

## Exercise 4: Blob Leasing for Concurrency Control

**AZ-204 Advanced Topic:** Blob leases provide pessimistic concurrency control.

### Acquire and Manage a Blob Lease

```bash
# Acquire a 60-second lease on a blob
LEASE_ID=$(az storage blob lease acquire \
  --account-name <sa-name> \
  --container-name labs \
  --blob-name test-file.txt \
  --lease-duration 60 \
  --query leaseId -o tsv)

echo "Lease ID: $LEASE_ID"
```

Try to delete the blob without the lease ID (this should fail):

```bash
az storage blob delete \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt
```

Delete with the lease ID:

```bash
az storage blob delete \
  --account-name <sa-name> \
  --container-name labs \
  --name test-file.txt \
  --lease-id $LEASE_ID
```

> **AZ-204 Exam Tip:** Leases are useful for distributed locking scenarios. Lease duration can be 15-60 seconds or infinite.

## Exercise 5: Static Website Hosting

**AZ-204 Exam Topic:** Enable and configure static website hosting on blob storage.

### Enable Static Website Hosting

```bash
az storage blob service-properties update \
  --account-name <sa-name> \
  --static-website \
  --index-document index.html \
  --404-document 404.html
```

Create a simple HTML page:

```bash
cat > index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>AZ-204 Static Site</title>
</head>
<body>
    <h1>Azure Blob Storage Static Website</h1>
    <p>This site is hosted on Azure Blob Storage for AZ-204 exam prep!</p>
</body>
</html>
EOF
```

Upload to the `$web` container (automatically created):

```bash
az storage blob upload \
  --account-name <sa-name> \
  --container-name '$web' \
  --name index.html \
  --file index.html \
  --content-type text/html
```

Get the static website URL:

```bash
az storage account show \
  --name <sa-name> \
  --query 'primaryEndpoints.web' -o tsv
```

Browse to the URL to see your static website.

ðŸ“‹ Create a custom 404 error page and upload it.

<details>
  <summary>Not sure how?</summary>

```bash
cat > 404.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>404 - Page Not Found</title>
</head>
<body>
    <h1>404 - Page Not Found</h1>
    <p>The page you are looking for doesn't exist.</p>
</body>
</html>
EOF

az storage blob upload \
  --account-name <sa-name> \
  --container-name '$web' \
  --name 404.html \
  --file 404.html \
  --content-type text/html
```

</details><br/>

## Exercise 6: Blob Versioning and Soft Delete

**AZ-204 Data Protection:** Protect against accidental deletion and modification.

### Enable Blob Versioning

```bash
az storage account blob-service-properties update \
  --account-name <sa-name> \
  --enable-versioning true
```

### Enable Soft Delete

```bash
az storage account blob-service-properties update \
  --account-name <sa-name> \
  --enable-delete-retention true \
  --delete-retention-days 7
```

Upload a blob and modify it:

```bash
echo "Version 1" > test.txt
az storage blob upload --account-name <sa-name> --container-name labs --name test.txt --file test.txt --overwrite

echo "Version 2" > test.txt
az storage blob upload --account-name <sa-name> --container-name labs --name test.txt --file test.txt --overwrite
```

ðŸ“‹ List all versions of the blob using `--include v` flag.

<details>
  <summary>Not sure how?</summary>

```bash
az storage blob list \
  --account-name <sa-name> \
  --container-name labs \
  --prefix test.txt \
  --include v \
  --query '[].{name:name, version:versionId, isCurrentVersion:isCurrentVersion}' \
  -o table
```

</details><br/>

## AZ-204 Exam Study Points

### Key Concepts to Master

1. **Blob Types:**
   - Block blobs (most common, for text/binary data)
   - Append blobs (optimized for append operations, logs)
   - Page blobs (for random read/write, VHD files)

2. **Access Tiers:**
   - Hot (frequently accessed)
   - Cool (infrequently accessed, 30+ days)
   - Archive (rarely accessed, 180+ days, offline)

3. **SAS Token Types:**
   - Account-level SAS (access to multiple services)
   - Service-level SAS (specific service only)
   - User delegation SAS (secured with Azure AD credentials - MOST SECURE)

4. **Lifecycle Management:**
   - Automatic tier transitions
   - Automatic deletion
   - Filter by prefix and blob type
   - Based on last modified or last accessed time

5. **Data Protection:**
   - Soft delete (retain deleted blobs)
   - Versioning (maintain blob versions)
   - Point-in-time restore
   - Immutable storage (legal hold, time-based retention)

6. **Metadata vs Properties:**
   - **Properties**: System-defined (Content-Type, ETag, Last-Modified)
   - **Metadata**: User-defined key-value pairs

### Common Exam Scenarios

1. **Scenario:** Application needs temporary read access to a private blob
   - **Solution:** Generate time-limited SAS token with read permissions

2. **Scenario:** Automatically archive logs older than 90 days
   - **Solution:** Implement lifecycle management policy with tierToArchive rule

3. **Scenario:** Host a static website with Azure Storage
   - **Solution:** Enable static website hosting on storage account, upload to $web container

4. **Scenario:** Prevent accidental blob deletion
   - **Solution:** Enable soft delete with appropriate retention period

5. **Scenario:** Control concurrent access to a blob
   - **Solution:** Use blob leases for pessimistic locking

## Cleanup

```bash
az group delete -y -n labs-storage-blob --no-wait
```

## Additional Resources

- [Azure Blob Storage documentation](https://docs.microsoft.com/en-us/azure/storage/blobs/)
- [Blob Storage SDK for .NET](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/storage.blobs-readme)
- [AZ-204 Storage Study Guide](https://learn.microsoft.com/en-us/credentials/certifications/resources/study-guides/az-204)
