# API Management Policies - AZ-204 Exam Context

## Exam Relevance

API Management policies are a key topic in the AZ-204 exam, specifically under the objective "Implement API Management."

You need to understand how to configure and apply policies to control API behavior without modifying backend code.

## Key Concepts for the Exam

### Policy Types and Execution Order

**Inbound Policies**
- Execute before the request reaches the backend
- Can modify the request
- Can short-circuit and prevent backend calls entirely
- Examples: authentication, rate limiting, request transformation, caching lookup

**Backend Policies**
- Execute when forwarding the request to the backend
- Less commonly used
- Can modify the backend URL or request

**Outbound Policies**
- Execute after the backend responds, before returning to the client
- Can modify the response
- Examples: header manipulation, response transformation, caching storage

**On-Error Policies**
- Execute when an error occurs at any stage
- Used for error handling and logging

### Policy Scope

Policies can be applied at different levels:
- **Global** - Applies to all APIs in the APIM instance
- **Product** - Applies to all APIs in a specific product
- **API** - Applies to all operations in an API
- **Operation** - Applies to a specific operation only

More specific scopes override broader scopes, but you can use the `<base />` tag to inherit policies from the parent scope.

## Important Policies for AZ-204

### Caching Policies

**cache-lookup and cache-store**
- Reduces load on backend services
- Improves response times
- Cache duration is configurable
- Can cache based on query parameters, headers, etc.

In this lab, we used:
```xml
<cache-lookup vary-by-developer="false" vary-by-developer-groups="false" />
```

Configuration duration: 86400 seconds (24 hours)

### Header Manipulation

**set-header**
- Add, modify, or remove HTTP headers
- Used for security (removing sensitive headers)
- Used for identification (adding custom headers)

Actions:
- **delete** - Remove a header
- **override** - Replace header value
- **append** - Add a value to an existing header
- **skip** - Don't set if it exists

### Response Transformation

**find-and-replace**
- Modifies response body content
- Uses string replacement
- Useful for URL rewriting, content sanitization

Example from this lab:
```xml
<find-and-replace from="swapi.dev/api" to="<YOUR-APIM-NAME>.azure-api.net/swapi" />
```

### Authentication and Security Policies

**validate-jwt**
- Validates JSON Web Tokens
- Enforces authentication at the API gateway level

**ip-filter**
- Allows or denies requests from specific IP addresses

**rate-limit and quota**
- Prevents API abuse
- rate-limit: limits calls per time period
- quota: limits total calls over a longer period

## Security Best Practices (Exam Relevant)

### 1. Hide Backend Implementation Details

**Why it matters:**
Exposing server information helps attackers identify vulnerabilities.

**How to address:**
- Remove or modify the Server header
- Don't expose backend error messages
- Use consistent error responses

In this lab: We removed the `nginx` Server header and added a custom `x-server` header.

### 2. Prevent Backend Bypass

**Why it matters:**
If clients can call the backend directly, they bypass your APIM policies.

**How to address:**
- Rewrite URLs in responses to point to APIM
- Use network security to restrict backend access
- Don't expose backend URLs in documentation

In this lab: We replaced all backend URLs with APIM URLs using find-and-replace.

### 3. Respect Backend Resources

**Why it matters:**
Backend services may have rate limits or capacity constraints.

**How to address:**
- Implement caching to reduce backend calls
- Use rate limiting at the APIM level
- Cache appropriate responses for appropriate durations

In this lab: We cached responses for 24 hours since Star Wars data doesn't change.

## Policy XML Structure

For the exam, you should understand the basic XML structure:

```xml
<policies>
    <inbound>
        <base />
        <!-- Inbound policies here -->
    </inbound>
    <backend>
        <base />
        <!-- Backend policies here -->
    </backend>
    <outbound>
        <base />
        <!-- Outbound policies here -->
    </outbound>
    <on-error>
        <base />
        <!-- Error handling policies here -->
    </on-error>
</policies>
```

The `<base />` tag inherits policies from the parent scope. Its position matters - policies before it execute before parent policies, policies after it execute after.

## Common Exam Scenarios

### Scenario 1: Rate Limiting
**Question type:** "Configure APIM to limit each subscription to 100 calls per minute"

**Solution:** Use rate-limit-by-key policy in inbound section:
```xml
<rate-limit-by-key calls="100" renewal-period="60"
                    counter-key="@(context.Subscription.Id)" />
```

### Scenario 2: JWT Validation
**Question type:** "Ensure all API calls include a valid JWT token from Azure AD"

**Solution:** Use validate-jwt policy in inbound section with Azure AD configuration.

### Scenario 3: Response Transformation
**Question type:** "Remove sensitive information from API responses"

**Solution:** Use set-header to remove headers or set-body with liquid templates to transform response bodies.

### Scenario 4: Backend URL Modification
**Question type:** "Route requests to different backends based on environment"

**Solution:** Use set-backend-service policy with conditional logic.

## Products and Subscriptions

Remember that policies work together with Products:
- APIs are added to Products
- Products require subscriptions
- Subscription keys are passed in the **Ocp-Apim-Subscription-Key** header
- Without a valid subscription key, you get a 401 Unauthorized response

In this lab, we verified this by testing without a subscription key first.

## Key Takeaways for AZ-204

1. **Policies modify API behavior without changing backend code**
2. **Four policy sections: inbound, backend, outbound, on-error**
3. **Policies can be applied at multiple scopes: global, product, API, operation**
4. **Common policies: caching, rate limiting, header manipulation, JWT validation**
5. **Security policies help hide implementation details and prevent backend bypass**
6. **The `<base />` tag controls policy inheritance**
7. **Subscription keys enforce authentication at the product level**
8. **Policy expressions use C# syntax for dynamic values**

## Hands-On Skills to Practice

For the exam, make sure you can:
- Navigate the Azure Portal to configure APIM policies
- Use both the visual designer and XML editor
- Apply common policies like caching, rate limiting, and header manipulation
- Test policies using the built-in test console
- Understand policy scope and inheritance
- Configure products and subscriptions
- Troubleshoot policy errors

Good luck with your AZ-204 exam preparation!
