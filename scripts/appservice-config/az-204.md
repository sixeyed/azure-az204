# App Service Configuration - AZ-204 Exam Connection

## Exam Objectives Covered

This lab directly addresses several AZ-204 exam objectives related to Azure App Service:

**Objective: Implement Azure App Service Web Apps**
- Configure application settings and connection strings
- Configure general settings such as platform settings and path mappings
- Enable diagnostic logging
- Configure health checks

**Objective: Configure App Service Plans**
- Scale App Service Plans up and down
- Scale out App Service Plans
- Configure App Service Plan pricing tiers

## Key Exam Topics

### 1. App Settings and Configuration

For the exam, you need to understand:

**App Settings as Environment Variables**: App settings in Azure override application configuration files. In .NET, they use double underscores to represent nested configuration. For example, `Rng__FailAfter__CallCount` maps to the configuration hierarchy:
```json
{
  "Rng": {
    "FailAfter": {
      "CallCount": 3
    }
  }
}
```

**Configuration Precedence**: App settings take precedence over values in configuration files. This allows you to deploy the same code to different environments with different configurations.

**Managing Settings via CLI**: The command pattern is:
```bash
az webapp config appsettings set --settings [KEY]='[VALUE]' -g [RESOURCE-GROUP] -n [APP-NAME]
```

You can set multiple settings at once by separating them with spaces:
```bash
az webapp config appsettings set --settings Setting1='value1' Setting2='value2' -g [RG] -n [APP]
```

### 2. Health Checks

Health checks are critical for production applications:

**Health Check Endpoint**: Your application should expose an endpoint that returns HTTP 200 when healthy and a 500-series error when unhealthy.

**Load Balancing Threshold**: This determines how many failed health checks occur before an instance is removed from the load balancer rotation. The minimum is 2, maximum is 10.

**Health Check Path**: Configure this in the App Service health check blade. Common patterns are `/health`, `/healthz`, or `/health/ready`.

**Metrics and Monitoring**: Health check results appear in Azure Monitor metrics, allowing you to set up alerts and dashboards.

### 3. Scaling App Service

Understanding scaling is essential for the exam:

**Scale Up vs. Scale Out**:
- Scale Up: Changing the SKU to get more CPU, memory, or features (vertical scaling)
- Scale Out: Increasing the number of instances (horizontal scaling)

**Worker Instances**: The number of instances running your application. More instances provide:
- Higher throughput
- Better availability
- Automatic traffic routing away from failed instances

**Scaling Commands**:
```bash
# Scale out (change number of instances)
az appservice plan update -g [RG] -n [PLAN] --number-of-workers [COUNT]

# Scale up (change SKU)
az appservice plan update -g [RG] -n [PLAN] --sku [SKU]
```

**SKU Tiers**:
- Free (F1) and Shared (D1): Shared infrastructure, no scale-out
- Basic (B1, B2, B3): Up to 3 instances, no autoscale
- Standard (S1, S2, S3): Up to 10 instances, autoscale available
- Premium (P1v2, P2v2, P3v2): Up to 30 instances, enhanced features

### 4. Auto-Heal Configuration

Auto-heal automatically restarts instances based on rules:

**Trigger Types**:
- Request count: Restart after a specified number of requests
- Slow requests: Restart if requests take too long
- Status codes: Restart on specific HTTP status codes (like 500 errors)
- Memory threshold: Restart when memory usage exceeds a threshold

**Actions**:
- Recycle: Restart the worker process
- Log event: Log the event without restarting
- Custom action: Run a custom executable

**Configuration Location**: Found in App Service > Diagnose and solve problems > Auto Heal, or in Configuration > General settings > Auto Heal rules.

### 5. Instance Management and Load Balancing

When running multiple instances:

**Traffic Distribution**: App Service load balances incoming requests across healthy instances using round-robin distribution.

**Unhealthy Instance Handling**: When health checks fail, App Service removes the instance from the load balancer but doesn't immediately restart it (unless auto-heal is configured).

**Single Instance Limitation**: With only one instance, App Service won't automatically replace it even if unhealthy, to avoid downtime.

## Exam Tips

1. **Know the CLI commands**: The exam may present scenarios where you need to choose the correct command syntax.

2. **Understand configuration hierarchy**: Be clear on how app settings override configuration files and connection strings.

3. **Remember minimum requirements**: Health checks require at least 2 instances to automatically remove unhealthy ones from rotation.

4. **SKU limitations**: Know which features are available in which pricing tiers.

5. **Auto-heal vs. health checks**: These are complementary but different features:
   - Health checks remove instances from load balancer rotation
   - Auto-heal restarts instances based on rules

6. **Deployment slots**: While not covered in this lab, remember that each deployment slot has its own app settings, and some settings can be marked as "slot settings" that don't swap.

## Practice Questions to Consider

- How do you configure an app setting via the Azure CLI?
- What happens when an App Service instance becomes unhealthy with only 1 worker?
- What's the minimum number of instances needed for automatic failover?
- How do you scale an App Service Plan to 3 instances?
- What status code should a health endpoint return when the app is healthy?
- What's the difference between scaling up and scaling out?

## Real-World Applications

In production scenarios, you would:

- Use deployment slots with slot-specific settings for staging and production
- Configure autoscale rules based on metrics like CPU usage or request count
- Set up Application Insights for detailed monitoring and diagnostics
- Use Azure Key Vault references for sensitive configuration values
- Implement comprehensive health checks that verify all dependencies
- Configure alerting based on health check failures

Understanding these concepts will help you both on the exam and in real-world Azure development.
