# Docker Multi-Stage Builds - AZ-204 Exam Connection

## AZ-204 Exam Relevance

### Exam Domain Coverage

This lab directly supports the AZ-204 exam objectives for **Implement containerized solutions**, specifically:

**Creating and managing container images:**
- Understanding Dockerfile syntax and multi-stage builds
- Optimizing container images for size and security
- Building images for different application platforms

**Publishing images to container registries:**
- Creating production-ready images suitable for Azure Container Registry
- Understanding image tags and versioning strategies

### Key AZ-204 Concepts

#### 1. Container Image Optimization

In the AZ-204 exam, you'll be tested on creating efficient container images. Multi-stage builds are the industry standard approach for optimization.

**Exam Scenario Example:**
"You need to containerize a .NET Core application for deployment to Azure Container Apps. The development team uses the .NET SDK for building, but you need to minimize the production image size. What approach should you use?"

**Answer:** Use a multi-stage Dockerfile with the .NET SDK image for building and the .NET runtime or ASP.NET image for the final stage.

#### 2. Azure Container Registry (ACR) Integration

When you push images to Azure Container Registry, smaller images mean:
- Faster push and pull times
- Lower storage costs
- Reduced bandwidth usage
- Quicker deployment to Azure Container Instances or Azure App Service

**ACR Build Example:**
```bash
az acr build --registry <YOUR-REGISTRY-NAME> \
  --image myapp:v1.0 \
  --file Dockerfile .
```

Multi-stage builds work seamlessly with ACR Build, allowing you to build images directly in Azure without maintaining build infrastructure.

#### 3. Azure Container Instances (ACI)

When deploying to Azure Container Instances, the image size directly impacts:
- Container startup time
- Cold start performance
- Costs (charges are based on CPU and memory usage during startup)

A 10MB image versus a 300MB image means significantly faster container initialization.

#### 4. Azure App Service Containers

For web apps running in Azure App Service on Linux, multi-stage builds help you create lean images that:
- Deploy faster when scaling out
- Start quickly during deployment slot swaps
- Reduce the time to recover from failures

#### 5. Security Best Practices

The AZ-204 exam emphasizes security. Multi-stage builds improve security by:

**Reduced Attack Surface:**
- SDK images contain compilers, debuggers, and development tools
- These tools have vulnerabilities and shouldn't be in production
- Final stage images contain only runtime dependencies

**Separation of Concerns:**
- Build-time secrets (like private package feeds) stay in build stages
- They never make it into the final image layer history

**Minimal Base Images:**
- Alpine Linux images are tiny (5MB) compared to full distributions
- Fewer packages mean fewer CVEs (Common Vulnerabilities and Exposures)
- Easier to scan and maintain compliance

### Exam Question Patterns

#### Pattern 1: Image Size Optimization

**Question Type:** "You need to containerize an application. The current Dockerfile produces a 500MB image. How can you reduce the image size?"

**Key Points to Remember:**
- Use multi-stage builds with SDK and runtime stages
- Start from minimal base images (Alpine, distroless)
- Copy only compiled artifacts to the final stage
- Use .dockerignore to exclude unnecessary files

#### Pattern 2: Build Efficiency

**Question Type:** "Your build pipeline takes 15 minutes to build container images. How can you improve build performance?"

**Key Points to Remember:**
- Enable BuildKit for parallel stage execution
- Order Dockerfile commands from least to most frequently changing
- Use build cache effectively
- Leverage Azure Container Registry tasks for cloud-based builds

#### Pattern 3: Targeting Specific Stages

**Question Type:** "You need to run automated tests during the container build but not include test frameworks in the production image. How should you structure the Dockerfile?"

**Key Points to Remember:**
- Create a test stage that runs after the build stage
- Use `--target` to build test images in CI/CD
- Final stage copies from build stage, not test stage
- BuildKit automatically skips unused stages

### Azure CLI Integration

For the AZ-204 exam, you should know these Azure CLI commands for working with container images:

**Login to Azure Container Registry:**
```bash
az acr login --name <YOUR-REGISTRY-NAME>
```

**Build image in ACR:**
```bash
az acr build --registry <YOUR-REGISTRY-NAME> \
  --image myapp:{{.Run.ID}} \
  --file Dockerfile .
```

**List images in ACR:**
```bash
az acr repository list --name <YOUR-REGISTRY-NAME> --output table
```

**Deploy to Azure Container Instances:**
```bash
az container create \
  --resource-group <YOUR-RESOURCE-GROUP> \
  --name mycontainer \
  --image <YOUR-REGISTRY-NAME>.azurecr.io/myapp:latest \
  --cpu 1 --memory 1 \
  --registry-login-server <YOUR-REGISTRY-NAME>.azurecr.io \
  --registry-username <YOUR-USERNAME> \
  --registry-password <YOUR-PASSWORD> \
  --dns-name-label myapp-<YOUR-UNIQUE-SUFFIX> \
  --ports 80
```

### Best Practices for AZ-204

When working with Docker for the AZ-204 exam context, remember:

**1. Always Use Multi-Stage Builds for Compiled Languages**
- Java, .NET, Go, Rust all benefit dramatically
- Even Node.js and Python can benefit from separating dev dependencies

**2. Understand Image Tagging Strategies**
- Use semantic versioning (v1.0.0, v1.0.1)
- Tag with build IDs for traceability
- Maintain latest tag for convenience

**3. Know the Cost Implications**
- Smaller images = lower ACR storage costs
- Faster pulls = lower egress costs
- Quicker starts = lower ACI compute costs

**4. Security Scanning**
- Azure Container Registry includes vulnerability scanning
- Smaller images have fewer vulnerabilities to scan
- Multi-stage builds help you exclude development dependencies

**5. Integration with Azure DevOps**
- Multi-stage builds work in Azure Pipelines
- Use Docker@2 task for building and pushing
- Leverage pipeline caching for Docker layers

### Sample AZ-204 Scenario

**Complete Scenario:**

"Contoso is containerizing their .NET Core Web API for deployment to Azure. The application uses Entity Framework Core and connects to Azure SQL Database. The development team uses the .NET 6.0 SDK for builds. You need to:

1. Create a Dockerfile that produces the smallest possible production image
2. Ensure the image can be built in Azure Container Registry
3. Deploy to Azure Container Instances with secure credential management
4. Minimize deployment time and costs"

**Solution Approach:**

1. **Multi-stage Dockerfile:**
   - Builder stage: `mcr.microsoft.com/dotnet/sdk:6.0` for building
   - Final stage: `mcr.microsoft.com/dotnet/aspnet:6.0-alpine` for minimal runtime

2. **Build in ACR:**
   - Use `az acr build` for serverless builds
   - Tag with semantic version and build ID

3. **Deploy to ACI:**
   - Use managed identity for ACR authentication (no passwords)
   - Store SQL connection string in Azure Key Vault
   - Reference Key Vault secrets in container environment variables

4. **Optimization:**
   - Alpine-based final image reduces size by ~60%
   - ACR geo-replication for faster pulls in different regions
   - Use ACI with spot instances for development environments

### Study Tips

For the AZ-204 exam:

1. **Practice building multi-stage Dockerfiles** for different languages
2. **Memorize common base image names** (dotnet/sdk, dotnet/aspnet, node, golang, python)
3. **Understand the --target flag** and when to use it
4. **Know BuildKit advantages** (parallel builds, automatic stage skipping)
5. **Practice Azure CLI commands** for ACR and ACI
6. **Understand cost and security implications** of image size

### Additional Resources

- Azure Container Registry documentation
- Docker best practices guide
- Azure Container Instances pricing calculator
- Azure Security Baseline for container images

Remember: The AZ-204 exam tests practical knowledge. Understanding why multi-stage builds matter in Azure (cost, security, performance) is as important as knowing how to write them.
