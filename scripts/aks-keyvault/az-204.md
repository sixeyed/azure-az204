# AKS with KeyVault Secret Storage - AZ-204 Exam Relevance

## Exam Domain Coverage

This lab directly supports several objectives in the AZ-204: Developing Solutions for Microsoft Azure exam:

### Implement Containerized Solutions (10-15% of exam)

**Create and manage container images for solutions**
- While this lab focuses on AKS rather than container creation, understanding how to deploy containerized applications in AKS is essential
- You should understand the full lifecycle: building images, storing them in ACR, and deploying them to AKS

**Publish an image to Azure Container Registry**
- This lab assumes your images are already in a registry
- In production scenarios, you'd pull images from ACR into your AKS deployments
- Integration between ACR and AKS is a common exam topic

**Run containers by using Azure Container Instance**
- While this lab uses AKS, understanding when to choose ACI versus AKS is important
- AKS is for orchestrated, multi-container workloads
- ACI is for simpler, single-container scenarios

### Implement Azure Security (15-20% of exam)

**Implement secure Azure solutions**
- This lab demonstrates securing application secrets using Azure Key Vault
- Key exam topics include:
  - Managed identities for Azure resources
  - Key Vault access policies
  - Securing configuration data

**Secure app configuration data by using App Configuration and Key Vault**
- This is directly tested on the AZ-204 exam
- You must understand how to store secrets in Key Vault
- You should know how applications retrieve secrets at runtime
- The CSI driver approach is one method; direct SDK access is another

## Key Concepts for the Exam

### Managed Identities

This lab heavily relies on managed identities, which is a crucial AZ-204 topic.

**What you need to know:**
- System-assigned vs. user-assigned identities
- How managed identities eliminate the need to store credentials in code
- How to grant managed identities access to Azure resources
- The difference between the identity and the service principal

In this lab, AKS uses a managed identity to authenticate with Key Vault. On the exam, you might see questions about:
- Configuring managed identity for App Service, Functions, or Container Instances
- Granting managed identity access to Key Vault, Storage, or other services
- Troubleshooting managed identity authentication issues

### Key Vault Access Patterns

The exam tests different ways to access Key Vault:

**1. CSI Driver (this lab)**
- Mounts secrets as files in containers
- Secrets are retrieved at pod startup
- Good for Kubernetes workloads
- Secrets appear as regular files in the filesystem

**2. Direct SDK Access**
- Application code uses Azure SDK to retrieve secrets
- Provides more control over when secrets are retrieved
- Can implement caching and refresh logic
- Common in App Service and Azure Functions

**3. App Service Configuration**
- Key Vault references in application settings
- Secrets are loaded as environment variables
- No code changes needed in the application

You should understand when to use each approach and their trade-offs.

### Azure Kubernetes Service (AKS)

While containerization is only 10-15% of the exam, you should understand:

**Core AKS Concepts:**
- Creating and managing AKS clusters
- Deploying applications using kubectl and YAML manifests
- Services, Deployments, and Pods
- Integration with ACR for image storage
- Network configuration (LoadBalancer, Ingress)

**AKS Add-ons:**
- HTTP application routing
- Azure Monitor for containers
- Azure Policy for Kubernetes
- Key Vault secrets provider (this lab)

**Security in AKS:**
- Managed identities for pod workloads
- Network policies
- Azure RBAC integration
- Private clusters

### Configuration Management

Configuration management is a cross-cutting concern on the AZ-204 exam.

**Configuration Hierarchy:**
1. Hard-coded defaults (least flexible)
2. Configuration files in the container image
3. ConfigMaps and Secrets in Kubernetes
4. Azure App Configuration
5. Azure Key Vault (most secure for secrets)

**Best Practices You Should Know:**
- Never store secrets in source control or container images
- Use Key Vault for sensitive data like connection strings and keys
- Use App Configuration for non-sensitive settings
- Use managed identities to access configuration services
- Implement configuration refresh without restarting applications

## Common Exam Scenarios

**Scenario 1: Application needs database connection string**
- Store the connection string as a secret in Key Vault
- Grant the application's managed identity "Get" permission on Key Vault secrets
- Use Azure SDK or Key Vault reference to retrieve the secret
- Never store the connection string in application settings or code

**Scenario 2: Multiple environments (dev, test, prod)**
- Create separate Key Vaults for each environment
- Use the same secret names across environments
- Configure application to use the correct Key Vault based on environment
- This allows the same code to work in all environments

**Scenario 3: Rotating secrets**
- Update the secret value in Key Vault
- Understand how long it takes for applications to pick up the change
- With CSI driver: depends on refresh interval (can take minutes)
- With SDK: depends on your caching logic
- With App Service: requires application restart

**Scenario 4: Troubleshooting access issues**
- Check managed identity is enabled
- Verify Key Vault access policy includes the identity
- Check Key Vault firewall settings
- Ensure soft-delete hasn't hidden the secret
- Review diagnostic logs

## Integration with Other Azure Services

The exam tests your understanding of how services work together:

**AKS + Key Vault + Managed Identity (this lab)**
- AKS cluster has a managed identity
- Key Vault access policy grants the identity permission
- CSI driver authenticates using the identity

**AKS + ACR + Key Vault**
- Store connection strings to external services in Key Vault
- Store container images in ACR
- AKS pulls images from ACR and mounts Key Vault secrets

**App Service + Key Vault**
- App Service uses managed identity
- Configuration references Key Vault secrets
- Secrets appear as environment variables

**Azure Functions + Key Vault**
- Similar to App Service
- Function can use bindings or SDK to access Key Vault
- Connection strings for triggers can reference Key Vault

## Hands-On Skills to Practice

For the AZ-204 exam, you should be able to:

1. Create a Key Vault and add secrets using Azure CLI or Portal
2. Enable managed identity on various compute services
3. Grant managed identity access to Key Vault using access policies
4. Configure applications to retrieve secrets from Key Vault
5. Troubleshoot authentication and authorization issues
6. Create and deploy containerized applications to AKS
7. Configure Kubernetes resources using YAML manifests
8. Understand the difference between Secrets in Kubernetes vs. Key Vault

## Study Tips

**Practice the Azure CLI commands:**
- Creating Key Vaults: `az keyvault create`
- Setting secrets: `az keyvault secret set`
- Setting access policies: `az keyvault set-policy`
- Creating AKS clusters: `az aks create`
- Getting credentials: `az aks get-credentials`

**Understand the YAML structure:**
- SecretProviderClass specifications
- Volume and volumeMount configurations in Kubernetes
- How to reference secrets in Deployment manifests

**Know the security best practices:**
- Always use managed identities when possible
- Grant least-privilege access (only "Get" if that's all you need)
- Use separate Key Vaults for different environments
- Enable audit logging on Key Vault
- Use private endpoints for Key Vault in production

## Real-World Applications

Understanding this integration is valuable beyond the exam:

- **Compliance**: Many industries require secrets to be stored in HSM-backed vaults
- **Audit**: Key Vault logs all access to secrets for compliance reporting
- **Centralization**: One Key Vault can serve multiple clusters and applications
- **Rotation**: Change secrets in one place without redeploying applications
- **Access Control**: Fine-grained control over who and what can access secrets

## Final Thoughts

This lab combines several AZ-204 exam domains:
- Containerized solutions (AKS)
- Security (Key Vault, managed identities)
- Azure services integration

The specific CSI driver approach is advanced, but the underlying concepts - using Key Vault for secrets and managed identities for authentication - are fundamental to the exam.

Focus on understanding the "why" behind each step, not just the "how." The exam will test your ability to choose the right approach for different scenarios, not just memorize commands.

Good luck with your AZ-204 preparation!
