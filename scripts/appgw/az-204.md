# Application Gateway - AZ-204 Exam Focus

## Exam Relevance

Application Gateway is covered in the AZ-204 exam under the "Implement Azure security" domain, specifically relating to implementing secure cloud solutions. Understanding Application Gateway and Web Application Firewall is essential for the exam as they represent Azure's application-layer traffic management and security capabilities.

## Key Concepts for AZ-204

### Layer 7 Load Balancing

For the exam, understand that Application Gateway operates at layer 7 of the OSI model, the application layer. This is different from Azure Load Balancer, which operates at layer 4.

Layer 7 load balancing means routing decisions are based on HTTP request attributes like:
- Host headers (domain names)
- URL paths
- Cookies
- Query strings

This enables more intelligent routing compared to network-level load balancing.

### Application Gateway Components

You need to know the key components of Application Gateway:

**Frontend IP Configuration**: The public or private IP address that clients connect to. Can be public, private, or both.

**Listeners**: Define how the gateway listens for incoming traffic. Multi-site listeners can host multiple websites on a single gateway by matching different host headers.

**Backend Pools**: Collections of backend resources like virtual machines, virtual machine scale sets, IP addresses, or FQDNs. The gateway distributes traffic across healthy members of the pool.

**Routing Rules**: Connect listeners to backend pools, defining how requests are forwarded. Rules can be basic (all requests go to one pool) or path-based (different URL paths go to different pools).

**Health Probes**: Continuously monitor backend resources to ensure they're responding. Unhealthy backends are automatically removed from rotation.

**HTTP Settings**: Define how traffic is sent to backends, including protocol, port, cookie-based affinity, and connection draining.

### SKU Tiers

Application Gateway comes in different SKU tiers you should know for the exam:

**Standard_v2**: Basic load balancing and SSL termination without WAF.

**WAF_v2**: Includes Web Application Firewall capabilities in addition to all Standard features. This is what we used in our lab.

The v2 SKUs support autoscaling, zone redundancy, and static VIPs, making them the recommended choice for production deployments.

### Web Application Firewall (WAF)

WAF is a critical security feature you need to understand:

**OWASP Core Rule Set**: WAF implements rules from the Open Web Application Security Project. Know that OWASP 3.2 is the latest version available, with 3.1 and 3.0 also supported.

**WAF Modes**:
- Detection Mode: Logs threats but doesn't block them. Use this for testing to identify false positives.
- Prevention Mode: Actively blocks detected threats. This is what you want for production.

**Rule Management**: You can disable specific rules if they cause false positives, or create custom rules for your specific needs.

### Routing Capabilities

For the exam, know these routing types:

**Basic Routing**: All requests to a listener go to a single backend pool. Simple but less flexible.

**Path-Based Routing**: Different URL paths route to different backend pools. For example:
- /api/* goes to API backend pool
- /images/* goes to image server pool
- /* goes to default web app pool

**Multi-Site Routing**: Different domain names or host headers route to different backend pools. This is what we configured in the lab with simple.appgw.azure.courselabs.co and pi.appgw.azure.courselabs.co.

### SSL/TLS Termination

Application Gateway can terminate SSL/TLS connections, decrypting traffic at the gateway level:

**SSL Termination**: Gateway handles decryption, reducing load on backend servers. Backend communication can use HTTP.

**End-to-End SSL**: Gateway decrypts to inspect traffic, then re-encrypts when forwarding to backends. This maintains encryption throughout but allows WAF inspection.

You need to upload SSL certificates to the gateway for SSL termination.

### Integration with Other Services

Understand how Application Gateway integrates with other Azure services:

**Azure Container Instances**: Can be used as backend pool members, as we demonstrated in the lab.

**Azure Kubernetes Service**: Application Gateway can serve as an AKS ingress controller.

**API Management**: Commonly deployed behind Application Gateway for additional security, especially when APIM is in internal VNET mode.

**Virtual Machine Scale Sets**: Can be configured as backend pools that automatically scale.

### Monitoring and Diagnostics

For the exam, know these monitoring capabilities:

**Metrics**: Application Gateway provides metrics like throughput, response time, failed requests, and healthy/unhealthy host counts.

**Diagnostic Logs**: Three log types are available:
- Access logs: Every request details
- Performance logs: Performance metrics
- Firewall logs: WAF detections and blocks

**Backend Health**: View real-time health status of backend pool members through the Portal or API.

### Common Scenarios and Troubleshooting

**502 Bad Gateway Errors**: The most common issue with Application Gateway. Typically means:
- No routing rule matches the request
- Backend is unhealthy or unreachable
- Backend is timing out
- NSG or firewall blocking traffic to backend

**Performance Optimization**: Use connection draining when updating backends, configure appropriate timeout values, and enable HTTP/2 for better performance with modern clients.

**WAF Tuning**: Start in Detection mode, monitor logs for false positives, then disable problematic rules or create exceptions before enabling Prevention mode.

### Security Best Practices

For the exam, know these security recommendations:

- Always use WAF_v2 SKU for internet-facing applications
- Enable Prevention mode in production after validating in Detection mode
- Use managed identities for certificate management with Key Vault integration
- Deploy Application Gateway in a dedicated subnet
- Use Network Security Groups to restrict traffic to the Application Gateway subnet
- Enable diagnostic logging for security auditing

### Cost Optimization

Understand these cost factors:

- Application Gateway pricing includes fixed hourly rate plus data processing charges
- v2 SKUs support autoscaling to optimize costs based on traffic
- Consolidate multiple applications on a single gateway using multi-site routing
- Delete gateway when not in use for development/testing scenarios

### CLI Commands You Should Know

Be familiar with these command patterns for the exam:

Creating an Application Gateway:
```
az network application-gateway create -g resource-group -n gateway-name --public-ip-address pip-name --vnet-name vnet-name --subnet subnet-name --sku WAF_v2
```

Creating a WAF policy:
```
az network application-gateway waf-policy create -n policy-name -g resource-group --type OWASP --version 3.2
```

Managing backend pools, listeners, and rules through CLI:
```
az network application-gateway address-pool create
az network application-gateway http-listener create
az network application-gateway rule create
```

### Comparison with Other Services

For exam questions comparing services, know:

**Application Gateway vs Load Balancer**: App Gateway is layer 7 (HTTP/HTTPS), Load Balancer is layer 4 (TCP/UDP). Use App Gateway for web applications, Load Balancer for general network traffic.

**Application Gateway vs Traffic Manager**: App Gateway routes traffic within a region at layer 7, Traffic Manager routes traffic across regions at the DNS level.

**Application Gateway vs Front Door**: Front Door is Microsoft's global layer 7 load balancer with CDN capabilities. Use Front Door for global applications, App Gateway for regional applications.

**Application Gateway vs API Management**: Different purposes - App Gateway for traffic routing and security, APIM for API management, throttling, and transformation. Often used together.

## Lab Takeaways for the Exam

From our lab, remember these key points:

1. Application Gateway requires a dedicated subnet in a VNet
2. WAF policies are created separately and attached to the gateway
3. Multi-site routing requires distinct host header values for each listener
4. Backend health probes must succeed for traffic to be routed
5. Rule priority matters when multiple rules could match a request
6. WAF blocks common attacks like SQL injection automatically with OWASP rules

## Practice Questions Focus

When practicing for the exam, focus on:

- Identifying the correct routing type for given scenarios
- Understanding when to use WAF_v2 vs Standard_v2
- Troubleshooting 502 errors and connectivity issues
- Configuring SSL termination and end-to-end SSL
- Choosing between Application Gateway and alternative services
- Understanding WAF Detection vs Prevention modes

## Additional Resources

For exam preparation, review:

- Microsoft Learn module on Application Gateway
- OWASP Top 10 web application security risks
- Application Gateway documentation on troubleshooting
- Integration patterns with AKS and API Management

Remember, the exam tests both theoretical knowledge and practical skills, so ensure you've completed hands-on labs like this one to build real experience with the service.
