We've discussed the challenge of managing multiple LoadBalancer services with random IP addresses, and how Application Gateway provides a centralized Layer 7 load balancing solution. Now let's implement it.

We'll begin by creating an Application Gateway manually rather than letting AKS create one automatically. This approach gives you more control over the configuration and means you can keep your Application Gateway running even if you remove your AKS cluster later. You'll start with a resource group, then create a public IP address with a DNS name that will be the entry point to all your apps. Since the Application Gateway needs to be deployed into the same VNet you'll use for your AKS cluster, you'll also create a VNet with two subnets: one for AKS and one for the Application Gateway. Application Gateway requires its own dedicated subnet that can't contain any other resources, which is an important Azure networking constraint.

When you create the Application Gateway itself, you'll need to use a v2 SKU because that's required to work with AKS. The Portal interface for creating an Application Gateway is unusual because each page has to be completed before you can move on. If you work through the pages in the Portal, you'll see the basics where you choose fixed scale or autoscaling, the frontends where you configure the public IP address, the backends where you define backend pools for traffic routing, and the configuration section for routing rules. This process takes a while, so once it's running, you can move on to the next step.

While the Application Gateway is being created, we'll explore AKS add-ons, which you can use to add new functionality to an existing cluster. You'll create an AKS cluster using the Azure network plugin and the AKS subnet in your VNet. You'll need the subnet ID for this command. When you integrate AKS with a VNet, the cluster needs permission to manage the network, so you'll see a message about waiting for AAD role to propagate. Your account needs elevated permissions in the subscription for this to work, which is fine on your own subscription but might be restricted in a corporate environment.

Once both the Application Gateway and the AKS cluster are ready, you can connect them by deploying the Application Gateway add-on to your AKS cluster. You'll get the Application Gateway ID and enable the add-on with the ingress-appgw parameter. This setup all takes a while to run, but when it's complete, you have a production-grade deployment that's ready for you to run scalable, reliable, public-facing apps with Kubernetes.

Now comes the exciting part: deploying with Application Gateway on AKS. You'll download the connection credentials for kubectl to use your AKS cluster, then deploy a simple whoami application that runs with ten replicas and a ClusterIP Service. For the Ingress object, you need to set the DNS name to match your public IP's fully-qualified domain name. You'll print the FQDN and edit the Ingress YAML file with that value. When you create the Ingress object and browse to the domain name, you should see the application being routed via Application Gateway, with load balancing working nicely between all the Pods.

The lab exercise has you exploring how the Application Gateway actually routes traffic into your containers. You'll navigate through the Application Gateway setup in the Portal to see how the routing works and discover the health checks that ensure traffic is only routed to healthy Pods. This helps you understand the integration between Kubernetes Ingress resources and Azure Application Gateway configuration.

Finally, the cleanup section shows you how to delete the resource group and change your Kubernetes context back to Docker Desktop. Let's implement centralized ingress for your AKS applications!
