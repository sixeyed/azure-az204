# Securing Apps with Key Vault and Virtual Networks - AZ-204 Exam Exercises

This lab covers several critical areas of the AZ-204 Developing Solutions for Microsoft Azure exam, bringing together multiple security and integration topics that appear throughout the certification. Understanding how to combine managed identities, Key Vault, storage security, and VNet integration represents the kind of holistic knowledge Microsoft expects from Azure developers.

## Prerequisites

You should be comfortable with the basics of Virtual Networks, App Service, and storage accounts before tackling this lab. This exercise builds on those fundamentals to demonstrate production-ready security patterns. The concepts here appear frequently in exam scenarios that require you to design secure cloud solutions.

## AZ-204 Exam Skills Covered

The exam expects you to demonstrate competency across several interconnected areas. Managing secrets with Azure Key Vault is fundamental, including creating vaults, storing secrets, and implementing secure retrieval patterns. Implementing managed identities eliminates credential management and represents Microsoft's preferred authentication approach. Configuring storage account security involves network rules, firewalls, and service endpoints. VNet integration for App Service enables secure access to restricted resources. Application configuration and troubleshooting rounds out the practical skills needed for the exam.

## Managing Secrets with Azure Key Vault

Key Vault appears throughout the AZ-204 exam as Microsoft's recommended approach for managing application secrets, keys, and certificates. Understanding when and why to use Key Vault versus alternatives is essential for making correct architectural decisions.

Secrets in Key Vault are versioned automatically, meaning every change creates a new version while preserving previous versions. This versioning enables rollback scenarios and audit trails showing what secrets existed at any point in time. The exam might present scenarios where you need to retrieve a specific version of a secret or understand why an application is using an old secret value.

Soft delete and purge protection provide additional layers of safety against accidental deletion. When soft delete is enabled, deleted secrets remain recoverable for a retention period, typically 90 days. Purge protection prevents even administrators from permanently deleting secrets during the retention period. The exam tests whether you understand these protection mechanisms and can recommend appropriate settings for different security requirements.

Access to Key Vault requires both authentication through Azure Active Directory and authorization through access policies or Azure RBAC. The exam distinguishes between these authorization models. Access policies provide granular permissions like get secrets, list secrets, or set secrets, which we used in this lab. Azure RBAC offers role-based access control integrated with the broader Azure permission model. Understanding when to use each approach appears in exam scenarios.

Key Vault references in App Service settings represent an advanced pattern where app settings can reference secrets stored in Key Vault using a special syntax. The application sees the secret value but never has direct access to Key Vault - App Service retrieves the secret on behalf of the app. This simplifies application code and centralizes secret management. The exam might present code or configuration snippets and ask you to identify this pattern or troubleshoot issues with it.

The connection string storage pattern we demonstrated represents a common real-world scenario. Storage account connection strings provide complete access to the account, making them highly sensitive. Storing them in Key Vault rather than app settings or environment variables follows security best practices. The exam frequently presents scenarios asking where sensitive configuration should be stored, and Key Vault is typically the correct answer.

## Implementing Managed Identities

Managed identities eliminate the need to store credentials in code or configuration, representing a paradigm shift from traditional authentication patterns. The AZ-204 exam tests this concept extensively because it's fundamental to secure Azure development.

System-assigned managed identities are created as part of an Azure resource and exist only as long as that resource exists. When you enable managed identity for an App Service, Azure creates an identity in Azure Active Directory and ties its lifecycle to the app. If you delete the app, the identity is deleted automatically. This automatic lifecycle management simplifies security but means the identity can't be shared across multiple resources.

User-assigned managed identities exist as independent Azure resources that you can assign to multiple services. If you have multiple apps or VMs that need the same permissions, a user-assigned identity lets you grant permissions once and share that identity. The exam tests whether you understand when to use system-assigned versus user-assigned identities based on scenario requirements.

Behind the scenes, managed identity uses a special endpoint available only from within Azure resources. Your application code requests a token from this endpoint, providing the resource it wants to access. Azure validates the request and returns an access token that your application uses for authentication. This happens transparently when using Azure SDKs, but understanding the mechanism helps troubleshoot authentication issues the exam might present.

The permissions granted to managed identities follow the principle of least privilege. In our lab, we granted only get and list permissions on secrets, not set or delete. The exam expects you to identify appropriate permission sets based on what an application actually needs. Overly permissive access violates security best practices and represents a wrong answer in exam scenarios.

Error messages related to managed identity authentication appear in troubleshooting questions. The "does not have secrets list permission" error we saw indicates correct authentication but insufficient authorization. The "ForbiddenByFirewall" error indicates authorization worked but network access was blocked. Understanding these distinctions helps you identify correct solutions in exam scenarios presenting error messages.

## Storage Account Security

Storage account security involves multiple layers that work together, and the exam tests your understanding of how these layers interact.

Network rules and firewalls control which networks can access a storage account. By default, storage accounts accept connections from any network, making them publicly accessible. The exam expects you to know that this default is inappropriate for production scenarios containing sensitive data. Adding network rules restricts access to specific virtual networks, IP address ranges, or Azure services.

Service endpoints versus private endpoints represent two approaches to securing storage account access from virtual networks, and understanding the difference is crucial for the exam. Service endpoints extend your VNet's identity to the storage service, allowing it to see requests as coming from your VNet. Traffic travels over Azure's backbone network rather than the public internet, but the storage account retains its public endpoint. Private endpoints give the storage account a private IP address in your VNet, completely removing public internet accessibility. The exam presents scenarios and expects you to choose the appropriate approach based on requirements.

Shared access signatures provide fine-grained time-limited access to storage resources without exposing the account key. The exam covers different types of SAS tokens including account SAS, service SAS, and user delegation SAS. Understanding when to use each type and how to generate them appears in code-based questions. However, managed identities represent the preferred approach when accessing storage from Azure services because they eliminate the need to manage SAS tokens or connection strings entirely.

The storage account connection string we stored in Key Vault contains both the account name and account key. This key provides complete administrative access to the storage account. The exam tests whether you understand the security implications of connection strings and know that they should never be stored in code, checked into source control, or placed in unsecured configuration locations.

## VNet Integration for App Service

App Service VNet integration enables outbound connectivity from your app to resources in a virtual network, and understanding this capability is essential for exam scenarios involving secure application architectures.

The critical distinction is that App Service apps don't run inside virtual networks. They're platform services hosted in Microsoft's multi-tenant infrastructure. VNet integration affects only outbound traffic from your app - traffic your app initiates to other services. Inbound traffic to your app from the internet remains unchanged unless you implement additional security like private endpoints or service endpoints for inbound App Service access. The exam tests whether you understand this outbound-only nature of VNet integration.

Regional VNet integration works with virtual networks in the same region as your App Service and represents the most common scenario. The subnet you integrate with must be delegated to Microsoft.Web/serverFarms, which reserves it exclusively for App Service use. The exam might present configuration requirements and expect you to identify that subnet delegation is necessary.

Gateway-required VNet integration works with virtual networks in different regions or with classic virtual networks, using a VNet gateway to establish connectivity. This approach is less common but might appear in exam scenarios involving legacy infrastructure or cross-region requirements. Understanding when gateway-required integration is necessary helps you select correct answers.

The integration process we demonstrated solved our Key Vault access problem by ensuring outbound calls from the app go through the subnet, which has service endpoint access to Key Vault. Without VNet integration, those calls came from App Service's public outbound IP addresses, which weren't in Key Vault's allow list. This pattern appears frequently in exam scenarios where apps need to access secured PaaS services.

DNS and routing considerations affect how VNet integration works. When you enable VNet integration, Azure configures routes so calls to private IP addresses go through the VNet. DNS resolution can use custom DNS servers you configure in the VNet, enabling access to on-premises resources through hybrid connectivity. The exam might present scenarios requiring on-premises database access from App Service and expect you to identify VNet integration with hybrid connectivity as the solution.

## Application Configuration and Troubleshooting

The app settings pattern we used demonstrates how Azure App Service makes configuration available to applications through environment variables or the configuration API depending on your application platform.

Hierarchical configuration keys using double underscores translate to nested configuration sections. Our "Database__Api" setting becomes a "Database" section with an "Api" property in .NET applications. The exam might show configuration code and ask you to identify the correct app setting name, or vice versa. Understanding these naming conventions helps you connect configuration to code.

Kudu represents the advanced management and diagnostic tool built into App Service, providing capabilities beyond what the Azure Portal offers. Log streaming shows real-time application output, which we used to diagnose our authentication and network issues. The exam expects you to know that Kudu exists and provides advanced troubleshooting capabilities when normal Portal features aren't sufficient.

Application Insights extends monitoring and diagnostics with telemetry, performance monitoring, and exception tracking. While not the primary focus of this lab, the exam tests whether you know how to enable Application Insights, interpret telemetry data, and use it for troubleshooting production issues. Integration with Key Vault and managed identities works similarly to other Azure services - Application Insights can use managed identity to authenticate and requires appropriate permissions.

Error diagnosis requires understanding the full stack from application code through Azure services. The authentication error we encountered indicated the app couldn't prove its identity to Key Vault. The network error indicated authentication worked but the request didn't come from an allowed network. The exam presents similar multi-step troubleshooting scenarios expecting you to identify the root cause and recommend appropriate solutions.

## Service Endpoints

Service endpoints appeared when we enabled them for Key Vault and Storage on our subnet, and understanding how they work is important for exam questions about network security.

Service endpoints change routing so traffic from your subnet to specified Azure services stays on Azure's backbone network instead of going through the internet. This provides better security because traffic never traverses public networks, and it offers better performance due to the optimized Microsoft network path. From the service's perspective, requests appear to come from your VNet's private IP space rather than public IPs.

Configuration happens at the subnet level by specifying which service types to enable, like Microsoft.KeyVault and Microsoft.Storage. Once enabled, the subnet can access those service types through private routing. The corresponding service must add network rules allowing your specific VNet and subnet. This two-sided configuration ensures you can't accidentally expose services and services can't be accessed unless explicitly allowed.

Service endpoints are free to use, making them attractive for cost-conscious scenarios. The exam might present cost optimization questions where service endpoints provide the right balance of security and cost. However, they don't provide true private connectivity like private endpoints do - the service retains its public endpoint and DNS name. Understanding this distinction helps you choose the right solution for different requirements.

Multiple subnets can have service endpoints enabled, and a single subnet can have endpoints for multiple service types. This flexibility lets you design network topologies matching your security requirements. The exam might present complex multi-subnet scenarios and expect you to identify which subnets need which service endpoints based on what resources they contain and what services they need to access.

## Best Practices and Patterns

The architecture we built represents a gold standard security pattern that appears throughout Microsoft documentation and exam scenarios.

Defense in depth layers multiple security controls rather than relying on single mechanisms. We used managed identity for authentication, network rules for access control, service endpoints for private connectivity, and Key Vault for secret storage. This layered approach means compromise of one control doesn't automatically breach the entire system. The exam tests whether you understand and can design layered security architectures.

Principle of least privilege appeared when we granted minimal permissions to the managed identity - only get and list on secrets, not broader permissions. The exam expects you to identify appropriately scoped permissions and recognize over-permissioned configurations as security issues.

Zero trust principles assume breach and verify explicitly. Managed identities implement zero trust by requiring authentication for every request rather than trusting network location. Network rules implement verification by checking source networks even for authenticated requests. The exam incorporates zero trust concepts and expects you to recognize patterns that support this model.

Infrastructure as code represents the path to repeatable, tested deployments of secure architectures. While this lab used CLI commands, the same architecture should be captured in ARM templates, Bicep, or Terraform for production use. The exam might ask about deploying these patterns consistently across environments or implementing them in CI/CD pipelines.

## AZ-204 Exam Study Points

Let's consolidate the key points you need to master for the exam. Azure Key Vault is the preferred location for application secrets with versioning, soft delete, and purge protection features. Managed identities eliminate credential management with system-assigned identities for single resources and user-assigned for sharing across multiple resources. Storage account security involves network rules, service endpoints, and private endpoints with appropriate choices based on requirements. VNet integration for App Service provides outbound connectivity to secured resources with regional and gateway-required options. Service endpoints provide private routing to Azure services through the Azure backbone network. Application configuration uses hierarchical naming with double underscores and integrates with Key Vault through references or code-based retrieval. Troubleshooting requires understanding authentication versus authorization and network versus permission issues.

Understanding these concepts at a practical level is what separates passing from failing the exam. Microsoft tests application of knowledge, not memorization. Practice the labs, understand why each feature exists and when to use it, and you'll be well-prepared.

## Cleanup

When you're finished with these exercises, removing the resource group deletes everything - all apps, all storage accounts, all Key Vaults, all VNets, and all associated resources. This cleanup is important not just for cost management but also because the exam sometimes includes questions about proper resource lifecycle management and cost optimization.
