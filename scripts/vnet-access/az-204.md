# Securing VNet Access - AZ-204 Exam Exercises

Network security appears throughout the AZ-204 exam as a critical component of developing secure cloud solutions. This lab directly addresses several key competencies tested in the Azure Developer Associate certification, particularly around implementing Azure security and developing for Azure compute services. Understanding how to secure network access is essential for building production-ready applications in Azure.

## Prerequisites

You should complete the basic VNet lab before diving into these security-focused exercises. The fundamental concepts like vnet creation, subnet configuration, and basic networking are essential building blocks. These exercises assume you're comfortable with the basics and ready to explore the security features that distinguish production deployments from simple development scenarios.

## AZ-204 Exam Skills Covered

The exam expects you to demonstrate competency across network security capabilities. You'll need to understand how Network Security Groups act as virtual firewalls controlling traffic at subnet and NIC levels. Azure Bastion provides secure management access without exposing SSH or RDP ports to the internet. VNet peering enables private communication between isolated networks. Rule priority and evaluation order determine which traffic is allowed or denied. Service tags simplify rule management for Azure services. Application Security Groups provide logical grouping of resources for security policy application. These skills appear throughout the exam in various scenarios requiring secure network design.

## Network Security Groups

Network Security Groups are a fundamental security control in Azure that you'll need to understand deeply for the exam. NSGs act as distributed virtual firewalls that you can apply at the subnet level to affect all resources in that subnet, or at the network interface level for per-VM control.

Understanding NSG rule evaluation is critical for the exam. Rules are processed by priority number, with lower numbers evaluated first. When Azure finds a matching rule, it stops processing and applies that rule's action, either allowing or denying the traffic. This means the order of your rules matters tremendously. You might have a deny-all rule at priority 4096, but an allow rule at priority 100 will take precedence because it's evaluated first.

Default rules exist in every NSG and cannot be deleted, though you can override them with higher-priority custom rules. The defaults allow incoming traffic from within the VNet so resources can communicate with each other, allow traffic from Azure Load Balancer for health probes, and deny all other inbound traffic from the internet. For outbound traffic, the defaults allow traffic to the VNet and to the internet, with a final deny-all rule as a safety catch. Understanding these defaults is important because exam questions might ask what happens when you apply an NSG without custom rules.

Source and destination specifications in NSG rules can use several formats that appear in exam scenarios. You can specify individual IP addresses for precise control, CIDR ranges for groups of addresses, service tags that represent Azure service IP ranges, or application security groups for logical resource groupings. Service tags are particularly important for the exam because they represent managed sets of IP addresses that Microsoft automatically updates. When you use the Storage service tag, your rule automatically includes all current storage service IPs across all regions, and Azure updates the tag when IP ranges change.

The stateful nature of NSGs simplifies rule management and appears in troubleshooting scenarios on the exam. When you allow inbound traffic on port 443, Azure automatically allows the return traffic outbound on the same connection. You don't need separate rules for request and response traffic. This differs from traditional stateless firewalls and is an important distinction for the exam.

Application at different levels gives you flexibility in security design. Subnet-level NSGs provide broad policies that apply to all resources in the subnet, perfect for tier-based security where an entire subnet represents a security zone. NIC-level NSGs provide per-resource control for exceptions and special cases. You can apply NSGs at both levels simultaneously, and Azure evaluates both sets of rules. The exam might present troubleshooting scenarios where subnet rules allow traffic but NIC rules deny it, or vice versa, requiring you to understand how both layers interact.

## Azure Bastion

Azure Bastion represents Microsoft's managed solution for secure VM access and appears frequently in exam scenarios involving security requirements. Traditional approaches to VM management involve opening SSH port 22 or RDP port 3389 to the internet, creating security risks from port scanning and brute force attacks. Bastion eliminates these risks completely.

The architecture of Bastion is important for exam questions. Bastion is deployed as a service at the VNet level, requiring its own dedicated subnet named AzureBastionSubnet. This dedicated subnet is a requirement, not an option, and the exam might test whether you know this. One Bastion deployment can serve all VMs within the VNet, making it a shared infrastructure resource rather than a per-VM service.

Connectivity through Bastion uses HTML5 browser-based access to VMs. You connect to the VM through the Azure Portal, and Bastion establishes the RDP or SSH connection server-side, then streams the session to your browser. From the VM's perspective, the connection comes from Bastion's private IP within the VNet, not from the internet. Port 22 and 3389 can remain completely blocked in your NSG rules because external clients never connect directly to those ports.

The security benefits make Bastion a preferred answer in many exam scenarios. VMs don't need public IP addresses at all when you use Bastion, reducing your attack surface significantly. Management ports are never exposed to the internet, eliminating the risk of port scanning and automated attacks. You don't need to manage jump boxes or VPN connections for VM access, simplifying your infrastructure. All Bastion connections log to Azure Monitor, providing audit trails for compliance and security investigations.

Cost considerations appear in optimization questions on the exam. Bastion has a fixed hourly cost regardless of how many VMs you access through it. If you have many VMs requiring management access, Bastion is more cost-effective and secure than alternative approaches. The exam might present a scenario with multiple VMs and ask for the most cost-effective secure management solution, and Bastion is typically the correct answer.

## VNet Peering

VNet peering enables private communication between isolated VNets and appears frequently in exam scenarios involving application architecture and network design. Understanding when to use peering versus alternatives like VPN gateways is essential for making correct architectural recommendations.

The bidirectional nature of peering is a key exam point. Peering is not automatic or implicit. You must create the peering connection from vnet A to vnet B, and separately create the peering from vnet B to vnet A. This bidirectional requirement exists for security, ensuring that you can't peer into someone else's VNet without their permission. Both sides must explicitly agree to the peering.

Address space planning is critical and appears in troubleshooting scenarios. Peered VNets must have non-overlapping CIDR ranges. If you try to peer 10.10.0.0/16 with 10.10.0.0/24, it fails because the ranges overlap. The exam might present a scenario where peering doesn't work and expect you to identify overlapping address spaces as the cause. This requirement emphasizes the importance of planning your network topology before deployment.

Peering is non-transitive, which is another critical exam concept. If vnet A peers with vnet B, and vnet B peers with vnet C, resources in vnet A cannot reach vnet C. There's no automatic routing through vnet B. This behavior provides security and control by ensuring you explicitly define all network paths. If you need full mesh connectivity between three VNets, you must create all three peering relationships explicitly. The exam tests whether you understand this limitation and can design appropriate topologies.

Global VNet peering extends peering across Azure regions and appears in disaster recovery and global application scenarios. You can peer a VNet in East US with a VNet in West Europe, enabling private communication across the globe using Azure's backbone network. Traffic never traverses the public internet, providing better security and predictable latency. The exam might describe a global application requiring private inter-region communication and expect you to recommend global VNet peering.

Gateway transit is an advanced peering feature that appears in hybrid connectivity scenarios. If one VNet has a VPN gateway or ExpressRoute gateway connecting to on-premises networks, you can enable gateway transit on the peering to allow the other VNet to use that gateway. This avoids the cost of deploying separate gateways in each VNet. The exam tests whether you understand when gateway transit is possible and how to configure it.

Network traffic between peered VNets uses Microsoft's backbone network and never traverses the public internet. This provides better security than internet-based connections and more predictable performance. Data transfer costs apply between peered VNets, with ingress typically free and egress charged. The exam might ask about cost optimization for cross-VNet communication, and understanding peering costs is important.

## Service Endpoints and Private Link

Service endpoints and Private Link represent complementary approaches to securing PaaS service access from VNets, and the exam tests your ability to choose between them based on requirements.

Service endpoints extend your VNet's identity to Azure services like Storage, SQL Database, and Key Vault. When you enable a service endpoint on a subnet, traffic from that subnet to the service routes through Azure's backbone network instead of the public internet. The service sees requests as coming from your VNet's private IP space, which enables you to configure firewall rules on the service allowing only your VNet. However, the service retains its public endpoint and DNS name. Service endpoints are free to use, making them attractive for cost-conscious scenarios.

Private Link takes a different approach by giving PaaS services a private IP address within your VNet. You create a private endpoint in your subnet, which is essentially a network interface with an IP from your subnet's range. When you connect to the service using this private endpoint, you're using private IP addressing, and the service appears as if it's deployed directly in your VNet. This enables scenarios like accessing Azure services from on-premises through VPN or ExpressRoute, completely disabling public access to services, and using private DNS zones for automatic name resolution.

The exam will present scenarios and expect you to choose between service endpoints and private endpoints based on requirements. If the scenario mentions on-premises access to an Azure service, private endpoints are required because on-premises networks can route to your VNet's private IP space through hybrid connections. If cost is a major consideration and public internet access to the service is acceptable with firewall restrictions, service endpoints are sufficient and free. If the requirement explicitly states "no public internet access at all" or "completely private," private endpoints are the only solution that truly makes the service private by removing its public endpoint.

## Multi-Tier Architecture Security

Multi-tier architectures with NSG-based security are common exam scenarios that test your ability to design defense-in-depth security models.

The classic pattern places web servers in a frontend tier with NSG rules allowing inbound traffic on ports 80 and 443 from the internet. Application servers reside in a middle tier with NSG rules allowing traffic only from the frontend tier. Database servers sit in a backend tier with NSG rules allowing traffic only from the application tier. This layered approach ensures that even if attackers compromise the frontend, they cannot directly access the database tier.

Implementing this pattern requires careful NSG rule design with appropriate priorities and source specifications. The frontend NSG allows inbound from the internet service tag on ports 80 and 443, but denies all other inbound traffic. Outbound rules allow traffic only to the application tier's subnet CIDR range. The application tier NSG allows inbound only from the frontend subnet CIDR, and outbound only to the backend subnet CIDR. The backend NSG allows inbound only from the application subnet CIDR and denies all other traffic.

Application Security Groups simplify this pattern when you have many VMs. Instead of updating NSG rules every time you add a VM, you assign VMs to ASGs like "web-servers," "app-servers," and "db-servers." Your NSG rules reference these ASGs rather than IP addresses. When you scale out by adding more web servers, you just assign them to the web-servers ASG, and they automatically inherit all appropriate rules. The exam might present a scenario with dynamic scaling requirements and expect you to recommend ASGs for security rule management.

## Troubleshooting Network Connectivity

The exam includes scenarios where network connectivity isn't working as expected, requiring you to diagnose the issue and recommend solutions.

Common issues start with NSG rules blocking traffic, which is often the first place to look. The effective security rules view in the Azure Portal shows the combined result of all NSG rules from both subnet and NIC levels, making it easier to see what's actually being allowed or denied. The exam might describe a situation where a connection fails and expect you to identify conflicting or missing NSG rules.

Route tables can cause connectivity issues when custom routes override Azure's default routing. Azure normally handles routing between subnets and to the internet automatically, but custom routes can break these paths if misconfigured. The exam might present a scenario where connectivity worked initially but broke after route table changes, expecting you to identify the routing issue.

Overlapping IP ranges prevent VNet peering and cause routing problems. The exam might describe a peering failure and provide the address spaces of both VNets, expecting you to identify the overlap. This emphasizes the importance of planning address spaces before deployment.

DNS resolution issues appear frequently with private endpoints. The service's public DNS name needs to resolve to the private IP address instead of the public IP when accessed from the VNet. This typically requires configuring private DNS zones and linking them to your VNet. The exam might describe connectivity issues after deploying a private endpoint and expect you to identify DNS configuration as the problem.

Network Watcher provides diagnostic tools that appear in troubleshooting questions. IP flow verify checks whether traffic between two endpoints would be allowed or denied based on NSG rules, helping you validate rule configurations without actually sending traffic. Connection troubleshoot performs end-to-end connectivity testing from a VM to a destination and identifies where the failure occurs. Next hop shows what route Azure would use for traffic to a destination. Packet capture enables detailed traffic analysis for complex issues. The exam expects you to know these tools exist and recommend the appropriate tool for different troubleshooting scenarios.

## Security Best Practices

The exam incorporates security best practices throughout scenario-based questions, testing whether you can make secure architectural decisions.

The principle of least privilege applies to network security. NSG rules should allow only the specific traffic required for functionality and deny everything else. Opening broad port ranges or allowing traffic from any source increases risk unnecessarily. The exam might present a proposed NSG configuration and ask whether it follows security best practices, testing your ability to identify overly permissive rules.

Management port exposure represents a common security mistake. SSH port 22 and RDP port 3389 should never be exposed to the internet in production environments. Use Azure Bastion or VPN connections for management access instead. The exam frequently includes scenarios requiring VM management access and expects you to recommend Bastion rather than public IP exposure.

Defense in depth layers multiple security controls rather than relying on a single mechanism. Multi-tier architectures with NSGs at each tier, combined with application-level security and authentication, provide better protection than any single control. The exam tests whether you understand layered security approaches and can design appropriate architectures.

Regular security reviews and updates keep your environment secure over time. NSG rules should be reviewed periodically to ensure they remain appropriate as your application evolves. The exam might ask about ongoing security management and expect you to recommend processes for rule review and updates.

## AZ-204 Exam Study Points

Let's consolidate the key points you need to master for the exam. Network Security Groups act as virtual firewalls with priority-based rule evaluation, and lower priority numbers are processed first. Default rules provide a secure baseline allowing VNet traffic and denying external traffic. Service tags simplify rules for Azure services and automatically update when IP ranges change. NSGs can apply at subnet level for broad policies or NIC level for per-resource control.

Azure Bastion provides secure VM access through browser-based SSH and RDP without exposing management ports. Bastion requires a dedicated AzureBastionSubnet and operates at the VNet level. VMs using Bastion don't need public IPs, significantly reducing attack surface.

VNet peering enables private communication between isolated VNets with bidirectional configuration required. Peered VNets must have non-overlapping address spaces. Peering is non-transitive, requiring explicit connections between all communicating VNets. Global VNet peering works across regions using Azure's backbone network.

Service endpoints extend VNet identity to PaaS services while keeping public endpoints. Private endpoints give services private IPs in your VNet and enable complete public access blocking. Choose based on requirements for on-premises access, cost constraints, and public endpoint acceptance.

Multi-tier architectures use NSGs at each tier for defense in depth. Application Security Groups simplify rule management with logical resource grouping. Network Watcher provides diagnostic tools for connectivity troubleshooting including IP flow verify and connection troubleshoot.

Understanding these concepts at a practical level is what separates passing from failing the exam. Microsoft tests application of knowledge, not memorization. Practice the labs, understand why each feature exists and when to use it, and you'll be well-prepared.

## Cleanup

When you're finished with these exercises, removing the resource group deletes everything - all VNets, all subnets, all VMs, all NSGs, all Bastion resources, all peering connections, and all associated resources. The no-wait flag lets the deletion proceed in the background so you can continue working. This cleanup is important not just for cost management but also because the exam sometimes includes questions about proper resource lifecycle management and cost optimization.
