# Securing AKS Apps with Key Vault and Virtual Networks - AZ-204 Exam Exercises

This lab addresses several critical domains of the AZ-204 certification exam, bringing together containerized solutions, security implementation, network configuration, and service integration. Understanding how to secure applications running in Azure Kubernetes Service is crucial because the exam tests your ability to design and implement production-ready, secure solutions. The patterns demonstrated here appear repeatedly across different Azure services and exam scenarios.

## Develop for Azure Compute - Container Solutions

The exam expects comprehensive understanding of containerized solutions on Azure. While AZ-204 focuses heavily on Azure Container Instances and Container Apps, the security and identity concepts demonstrated in this lab apply universally across all container services. You'll need to understand how to deploy container instances and apps, configure container settings and environment variables, manage container identity and security, and integrate containers with other Azure services.

Deploying to Azure Kubernetes Service showcases the most advanced container orchestration option Azure offers. The exam might not dive deep into Kubernetes specifics, but understanding how containers access other Azure resources through managed identities and how networking secures those interactions is fundamental to passing. The principle of treating containers as first-class citizens in your Azure architecture, with proper identity and network integration, is what the exam values.

## Implement Azure Security - Managed Identities

Managed identities represent one of the most important security features in Azure and appear frequently throughout the AZ-204 exam. Understanding the difference between system-assigned and user-assigned managed identities is crucial. System-assigned identities have a one-to-one relationship with the resource they're assigned to and are automatically deleted when that resource is deleted. User-assigned identities exist independently and can be associated with multiple resources, persisting even when those resources are removed.

In this lab, the AKS KeyVault Secrets Provider add-on creates a user-assigned managed identity automatically. This identity authenticates to Key Vault on behalf of your pods, eliminating the need to store credentials in code, configuration files, or Kubernetes secrets. The exam loves this pattern because it demonstrates credential-free authentication, which is the gold standard for Azure security.

The exam expects you to understand the complete lifecycle - creating or identifying a managed identity, granting it permissions on target resources through RBAC or access policies, and configuring your application or service to use that identity for authentication. You'll see scenarios where you need to choose between system-assigned and user-assigned identities based on requirements. Generally, use system-assigned for single-resource scenarios where the identity should be tightly coupled to the resource, and use user-assigned when multiple resources need to share an identity or when the identity needs to persist independently.

## Implement Azure Security - Key Vault

Key Vault is heavily tested on the AZ-204 exam across multiple question types. You must know how to create and configure Key Vault instances using both Portal and CLI, store and retrieve secrets with proper access control, configure access policies and understand the transition to RBAC, integrate Key Vault with applications using the Azure SDK, implement Key Vault references in App Service and Functions, and secure Key Vault using network restrictions and private endpoints.

This lab demonstrated the complete Key Vault lifecycle in a production scenario. Creating the vault, storing a secret from a file, configuring access policies to grant specific permissions to a managed identity, and restricting network access using virtual network rules all represent exam-relevant skills. The pattern of loading secrets into application containers through volume mounts rather than environment variables is important because it's more secure - secrets aren't visible in pod specifications or through standard Kubernetes inspection commands.

The exam might ask you to write code that accesses Key Vault using the Azure SDK. Understanding the client libraries for secrets, keys, and certificates is important. You'll need to know how to authenticate using DefaultAzureCredential, which automatically tries managed identity, environment variables, and other credential sources in sequence. You'll also need to understand the structure of Key Vault URIs and how to reference specific secret versions versus always retrieving the latest version.

Network security for Key Vault appears in many exam scenarios. Understanding that you can allow access from specific virtual network subnets using service endpoints, allow access from specific IP addresses, or use private endpoints to give Key Vault a private IP address within your VNet are all exam-relevant topics. The default action of deny with explicit allow rules represents defense-in-depth security, which the exam values highly.

## Implement Azure Security - Network Security

Network security pervades many AZ-204 scenarios because modern Azure applications typically span multiple services that need secure communication paths. You need to understand virtual networks and subnets as the foundation of Azure networking, network security groups for traffic filtering using rules, service endpoints for optimized routing to Azure PaaS services, and private endpoints for bringing Azure services into your VNet address space.

Service endpoints, which we used in this lab, are subnet-level configurations that enable traffic to reach Azure services over the Microsoft backbone network while allowing those services to identify and filter traffic based on the source subnet. This is different from the public internet path. When you enable the Microsoft.KeyVault service endpoint on a subnet and then add network rules to Key Vault allowing that subnet, traffic flows efficiently and securely while maintaining the service's public endpoints.

Private endpoints take this further by giving Azure services like Key Vault or Storage Account an actual private IP address within your VNet. This makes the service appear as if it's inside your network, with traffic never leaving your VNet. The exam might present scenarios where you need to choose between service endpoints and private endpoints. Service endpoints are simpler and less expensive but still use public IPs under the hood. Private endpoints provide true VNet integration but cost more and require DNS configuration.

Understanding how Azure CNI networking works with AKS is important for this lab's scenario. With Azure CNI, each pod gets its own IP address from your subnet's address space, making pods first-class network citizens. This is different from kubenet, where pods use an overlay network with private addresses. Azure CNI is required when you need to apply Azure network policies directly to pods or when you want to access pods directly from other resources in your VNet.

## Connect to and Consume Azure Services - Storage

Storage Accounts are fundamental to almost every Azure solution and appear extensively throughout the AZ-204 exam. You need comprehensive knowledge of creating and configuring storage accounts with appropriate redundancy and performance tiers, working with blob storage containers and understanding access tiers, using queue storage for messaging patterns, working with table storage for NoSQL data, securing storage using access keys, shared access signatures, and managed identity, configuring storage firewalls and network rules, and understanding connection strings and their components.

This lab focused on storage security specifically. The connection string contains the storage account name, account key, and endpoints all in one string. This provides complete access to the storage account, which is why storing it in Key Vault rather than in code or configuration files is critical. The exam expects you to recognize that connection strings should never be hardcoded or checked into source control.

Multiple authentication methods exist for Storage Accounts, and the exam tests your knowledge of when to use each. Access keys provide full access and should be protected like passwords. Shared access signatures are time-limited tokens with specific permissions on specific resources - they're excellent for granting temporary access to external parties. Managed identity provides credential-free authentication and represents the most secure option when connecting from Azure services. Understanding the security hierarchy - prefer managed identity when possible, use SAS tokens when you need to grant temporary access, and avoid access keys in production code - is crucial for the exam.

Storage firewall configuration mirrors Key Vault's approach. You can restrict access to specific virtual network subnets using service endpoints, allow access from specific IP address ranges, or use private endpoints for complete VNet integration. The exam might present scenarios where an application can't access storage and you need to diagnose whether it's an authentication issue, a network rule issue, or both.

## Kubernetes Integration Patterns

While Kubernetes itself isn't extensively covered on the AZ-204 exam, understanding how containerized solutions work helps you with Azure Container Apps, which is built on Kubernetes and KEDA. Pods are the smallest deployable units, essentially wrapper around one or more containers. Services expose pods on the network using load balancing. Deployments manage pods with desired state configuration and rolling updates. ConfigMaps and Secrets provide configuration and sensitive data to applications.

The Secrets Store CSI Driver represents a Kubernetes-native pattern for integrating with external secret stores. Rather than copying secrets into Kubernetes Secrets and then mounting those to pods, the CSI driver mounts secrets directly from Key Vault as volumes. This is more secure because secrets never exist as Kubernetes objects visible through kubectl commands. The pods see secrets as files in the mounted volume, and the CSI driver handles authentication to Key Vault using the managed identity.

Understanding volume mounts versus environment variables for secrets is exam-relevant. Environment variables are simpler but less secure - they appear in pod specifications and can be viewed by anyone with kubectl access. Volume-mounted secrets are only accessible to processes inside the container with file system access, and they don't appear in pod metadata. The exam values security-conscious choices, so preferring volume mounts for sensitive data demonstrates proper security understanding.

## Production Security Patterns

This lab demonstrates a production-ready security architecture that exemplifies Azure best practices. Using managed identities eliminates credential storage and management burden. Storing secrets in Key Vault provides centralized secret management with audit logging and access control. Restricting network access using service endpoints implements defense-in-depth security by reducing attack surface. Applying the principle of least privilege means granting only the minimum permissions required. Layering multiple security controls means that if one control fails, others still provide protection.

The exam doesn't just test your knowledge of individual features - it tests your ability to combine features into secure, well-architected solutions. This lab's pattern of VNet-integrated AKS accessing Key Vault through managed identity with network restrictions represents exactly the kind of solution the exam expects you to design.

Understanding the attack vectors this architecture prevents is important for exam reasoning. Without managed identity, you'd need to store credentials somewhere, creating a credential theft risk. Without Key Vault, secrets might be in code or configuration files, risking exposure through source control or configuration management systems. Without network restrictions, Key Vault and Storage are accessible from anywhere on the internet, expanding attack surface unnecessarily. The exam values solutions that minimize risk at each layer.

## Common Exam Scenarios

You'll encounter scenarios where an application running in a container needs to access Key Vault secrets. The exam expects you to recommend using managed identity for authentication and Key Vault references or SDK access for retrieving secrets. Understanding that you need to grant the managed identity appropriate permissions on Key Vault is crucial.

Network restriction scenarios are common. You might see a situation where Key Vault or Storage Account needs to be accessible only from specific Azure services. The solution involves enabling appropriate service endpoints on the subnet, adding network rules to allow that subnet, and setting the default action to deny. Understanding that service endpoint configuration happens in two places - enabling on the subnet and allowing in the service's firewall - is important.

Integration scenarios might describe an application that needs database connection strings, storage account keys, or API credentials. The exam expects you to identify Key Vault as the storage location, managed identity as the authentication method, and either Key Vault references for App Service, SDK access for code, or CSI driver for AKS as the retrieval mechanism depending on the compute platform.

Troubleshooting scenarios might describe an application that can't access Key Vault or Storage Account. You need to check multiple factors - is the managed identity properly configured, does the identity have appropriate permissions through access policies or RBAC, are network rules properly configured on both the subnet and the service, and is the application using the correct URI and authentication method. The exam tests your ability to systematically diagnose where in this chain the problem exists.

## Preparation Recommendations

Practice creating Key Vaults and managing secrets using both the Azure CLI and Azure SDK. Write code that authenticates using DefaultAzureCredential and retrieves secrets, as code-based questions appear on the exam. Understand the difference between Key Vault access policies and RBAC, as both approaches are supported and you need to know when to use each. Access policies provide granular permissions on keys, secrets, and certificates. RBAC provides Azure-wide role management but might offer less granular control for some scenarios.

Work with managed identities across different Azure services to understand how they function in various contexts. Enable managed identity on App Service, Functions, Virtual Machines, and Container Instances. Grant those identities access to different resources and observe how authentication works without credentials. This hands-on experience builds intuition for exam questions.

Configure service endpoints and network rules for multiple Azure services. Understanding that the pattern is consistent across services - enable service endpoint on subnet, add network rule to allow subnet, set default action to deny - helps you answer questions about services you might not have used directly. The same principles apply whether you're securing Key Vault, Storage Account, SQL Database, or Cosmos DB.

Understand connection string formats for different services. Storage connection strings, SQL connection strings, and Cosmos DB connection strings all have different formats, and exam questions might ask you to identify components or construct connection strings. Knowing that sensitive components should come from Key Vault rather than being hardcoded is crucial.

Write Kubernetes YAML manifests by hand to understand pod specifications, volume mounts, environment variables, and service definitions. While AZ-204 doesn't extensively test Kubernetes, understanding containerized application patterns helps with Container Apps questions, which use similar concepts. Understanding how applications receive configuration through environment variables versus volume mounts appears across multiple compute options.

## Cleanup and Cost Management

Understanding resource lifecycle and cost management is important for the exam. AKS clusters incur costs for the VM nodes even when idle, making prompt cleanup important. Key Vaults have soft-delete enabled by default, meaning deleted vaults remain in a deleted state for 90 days unless purged, and their names can't be reused during this period. Storage Accounts charge for capacity used plus transaction costs. Understanding these cost factors helps you make informed architectural decisions, which the exam sometimes tests through cost optimization scenarios.

The pattern of using resource groups to organize related resources and delete everything together is an Azure best practice that simplifies lifecycle management. When you delete a resource group, all contained resources are deleted in the correct order, handling dependencies automatically. This is much simpler than manually deleting individual resources and ensures complete cleanup.
